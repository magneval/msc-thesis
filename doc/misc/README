= Diploma 2 log

== 1st week

=== 2011-09-06

In ULX, meeting with Gabor, Ivan and Akos, discussing what "workflow
integration in an office environment" means.

No consensus, next meeting scheduled later this week.

=== 2011-09-07

Replied to redmine ticket: the LPSP extension fails to open a GUI window on
OSX. I already found a possible fix, searched the exact commit and bug id.

Set up a sharepoint virtual machine on localhost. (I can't get wireshark to
monitor the traffic in both directions when sharepoint runs on a remote virtual
machine.)

=== 2011-09-08

Meeting with Akos: we clarified most of the points in the initial "for this
semester" spec, I need to write up a more detailed one.

Meeting with Ivan and Gabor: more discussion, especially about what does a
long-term workflow stand for, decision points and undoing a task assignment.

Wrote up a more detailed spec in SVN.

=== 2011-09-09

In ULX. Ivan pointed out a drools (including jbmp5) demo they set up earlier:

http://droolsdemo-process:8080/gwt-console/
http://droolsdemo-process:8080/gwt-console-server/

Based on that, I'm trying to set up my own jbmp instance. Downloaded
jbpm-5.1.0.Final-installer-full.zip from
http://sourceforge.net/projects/jbpm/files/jBPM%205/jbpm-5.1.0.Final/.

Following the install.html from that ZIP, I get a web console at
http://localhost:8080/jbpm-console, and the REST API at
http://localhost:8080/gwt-console-server/.

Found more documentation at: http://docs.jboss.org/jbpm/v5.1/userguide/

This was also helpful: http://jkrzemie.wordpress.com/2011/03/30/jbpm-5-0-creating-simple-human-tasks-with-variables/

Questions:
- where are human task templates stored? -> looks like in separate .ftl files, have to be deployed using guvnor.
- user management? -> should be plain ini-like text files under auth/, but that did not really work here for some reason.
- rest interface auth problems -> the example provided in the documentation is obsolete, using apache httpclient should be a solution, example here: http://anonsvn.jboss.org/repos/riftsaw/trunk/samples/quickstart/management/src/org/jboss/riftsaw/management/ManagementClient.java

=== 2011-09-10

- I have a working example on how to authenticate and get list of personal tasks as JSON.
- Also read about gson: http://code.google.com/p/google-gson/ which is used by
  jboss to serialize / unserialize java objects to/from json. I now have a
  working example on how to build a List<Task> object from a JSON result (as
  far as I see, it's necessary to write TaskRef.java and TaskRefWrapper.java
  manually to do so).

Then I looked at related work. Keywords: 'document based workflow',
'document-driven workflow', 'document-centric workflows'.

- http://php.scripts.psu.edu/faculty/a/x/axk41/BPM05-jerry-reprint.pdf
  A framework for document-driven workflow systems (J Wang)
  -> details why information and resource based workflows are also important, not just control based ones
  -> idea: user changes the document, change listeners intercepts changes, check constraints, then accept or reject
           various complex features planned: split/merge of documents, different locking types
  -> implementation using sql triggers (ugh)
  -> detailed comparison of control flow based vs. document based approach (pro/con)
- https://mailserver.di.unipi.it/ricerca/proceedings/ICSE2008/sam/p21.pdf
  Mobility in the virtual office: a document-centric workflow approach (R Carbon, G Johann, T Keuler, D Muthig)
  -> introduces decentralized document-driven workflows, where changes to workflows travel with the documents
     decentralization is handled with a peer-to-peer architecture
- http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.86.6547&rep=rep1&type=pdf
  XDoC-WFMS: A Framework for Document Centric Workflow Management System (R Krishnan, L Munaga)
  -> great examples where document-centric approach is intuitive: newspaper editing, processing job applications
  -> idea: documents have an embedded micro-agent, so the document itself will know where to submit, etc.
- http://ce.sharif.edu/~yuosefsa/article/CS.pdf
  Access control in document-centric workflow systems--an agent-based approach (RA Botha)
  -> an approach without decoupling: here the workflow object communicates with the document object

=== 2011-09-11

Worked on the 'recently used documents' feature in the extension, requested by Ivan.

Version to test: lpsp-0.1-387-g273a329.oxt

Implemented functions:
- modified the extension configuration schema, so it can store a list of recently used URL's for each configured server.
- when opening a document, that list is loaded from $HOME/.openoffice.org/3/user/registrymodifications.xcu, the opened document is inserted to the start of the list, then saved.
- there is a new button in the file picker, making it possible to view this list
- the 'up' button can be used to return to the root directory from the recently used documents

== 2nd week

=== 2011-09-12

Worked on the favorites feature in the extension.

Version to test: lpsp-0.1-396-g4ecd817.oxt

Implemented functions:
- new button to add a folder or file to favorites
- add/delete is first confirmed using a popup dialog
- new button to list favorites
- as with recently used documents, the 'up' button can be used to return to the root directory

=== 2011-09-13

Created my first BPMN with two human tasks (and committed to SVN). That sounds
easy, but there were two pitfalls:

- starting the h2 database and then starting jboss is not enough, there is a need to start a separate 'human task server' as well

So the proper way to restart jbpm after changing the BPMN and/or templates is:

----
ant stop.jboss && ant stop.h2 && ant start.h2 && ant start.jboss && ant start.human.task
----

- creating a new BPMN does not work with 'File -> New -> File', and just using
  the `.bpmn` extension, as that results in an XML reader exception, what works
  is: 'File -> New -> Other', then 'Drools -> Flow file'

=== 2011-09-14

In ULX. Worked on completing a task via REST API, created an example
successfully. First I thought it will be easy as the login form already used
UrlEncodedFormEntity successfully, but on task completion a MultipartEntity
should be used to send the (empty) form.

Ported the sample codes to http-core 4.x (that is needed, as 3.x has a
different api, not supporting NTLM auth). Created a WFHandler (similar to the
Handler of the sharepoint jar):

- it can check username/password - login
- can list assigned tasks
- can complete a task
- can get the document url of a task
- can list documents: it simulates a root directory with documents, extracted from assigned tasks.

Figured out how to add new users to jbpm and/or change password: there is an
auth/users.properties file, but that's used by the installer only. The real
configuration file is under jboss-*/server/default/conf/users.properties. Once
updated and jbpm is restarted, logging in with the new user works fine.

Then - for some unknown reason - the eclipse of jbpm stopped recognizing bpmn
files as a graphically editable object, finally I had to re-deploy the eclipse
configuration.

Finally a problem: assigning a task to the user `krisv` works, but when I try to assign a task to the user `admin`, I get:

----
     [java] javax.persistence.RollbackException: Error while commiting the transaction
     [java]     at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:71)
     [java]     at org.jbpm.task.service.TaskServiceSession.doOperationInTransaction(TaskServiceSession.java:820)
     [java]     at org.jbpm.task.service.TaskServiceSession.addTask(TaskServiceSession.java:134)
     [java]     at org.jbpm.task.service.TaskServerHandler.messageReceived(TaskServerHandler.java:109)
     [java]     at org.jbpm.task.service.mina.MinaTaskServerHandler.messageReceived(MinaTaskServerHandler.java:41)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$TailFilter.messageReceived(DefaultIoFilterChain.java:713)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.access$1200(DefaultIoFilterChain.java:46)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$EntryImpl$1.messageReceived(DefaultIoFilterChain.java:793)
     [java]     at org.apache.mina.filter.codec.ProtocolCodecFilter$ProtocolDecoderOutputImpl.flush(ProtocolCodecFilter.java:375)
     [java]     at org.apache.mina.filter.codec.ProtocolCodecFilter.messageReceived(ProtocolCodecFilter.java:229)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.access$1200(DefaultIoFilterChain.java:46)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$EntryImpl$1.messageReceived(DefaultIoFilterChain.java:793)
     [java]     at org.apache.mina.filter.logging.LoggingFilter.messageReceived(LoggingFilter.java:176)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.access$1200(DefaultIoFilterChain.java:46)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$EntryImpl$1.messageReceived(DefaultIoFilterChain.java:793)
     [java]     at org.apache.mina.core.filterchain.IoFilterAdapter.messageReceived(IoFilterAdapter.java:119)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.fireMessageReceived(DefaultIoFilterChain.java:426)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.read(AbstractPollingIoProcessor.java:638)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.process(AbstractPollingIoProcessor.java:598)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.process(AbstractPollingIoProcessor.java:587)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.access$400(AbstractPollingIoProcessor.java:61)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor$Processor.run(AbstractPollingIoProcessor.java:969)
     [java]     at org.apache.mina.util.NamePreservingRunnable.run(NamePreservingRunnable.java:64)
     [java]     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
     [java]     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
     [java]     at java.lang.Thread.run(Thread.java:679)
     [java] Caused by: org.hibernate.exception.ConstraintViolationException: Could not execute JDBC batch update
     [java]     at org.hibernate.exception.SQLStateConverter.convert(SQLStateConverter.java:94)
     [java]     at org.hibernate.exception.JDBCExceptionHelper.convert(JDBCExceptionHelper.java:66)
     [java]     at org.hibernate.jdbc.AbstractBatcher.executeBatch(AbstractBatcher.java:275)
     [java]     at org.hibernate.engine.ActionQueue.executeActions(ActionQueue.java:266)
     [java]     at org.hibernate.engine.ActionQueue.executeActions(ActionQueue.java:168)
     [java]     at org.hibernate.event.def.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:321)
     [java]     at org.hibernate.event.def.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:50)
     [java]     at org.hibernate.impl.SessionImpl.flush(SessionImpl.java:1027)
     [java]     at org.hibernate.impl.SessionImpl.managedFlush(SessionImpl.java:365)
     [java]     at org.hibernate.transaction.JDBCTransaction.commit(JDBCTransaction.java:137)
     [java]     at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:54)
     [java]     ... 29 more
     [java] Caused by: org.h2.jdbc.JdbcBatchUpdateException: Referential integrity constraint violation: "FK27A9A59E619A0: PUBLIC.TASK FOREIGN KEY(CREATEDBY_ID) REFERENCES PUBLIC.ORGANIZATIONALENTITY(ID)"; SQL statement:
     [java] update Task set allowedToDelegate=?, taskInitiator_id=?, priority=?, activationTime=?, actualOwner_id=?, createdBy_id=?, createdOn=?, documentAccessType=?, documentContentId=?, documentType=?, expirationTime=?, faultAccessType=?, faultContentId=?, faultName=?, faultType=?, outputAccessType=?, outputContentId=?, outputType=?, parentId=?, previousStatus=?, processInstanceId=?, skipable=?, status=?, workItemId=? where id=? [23002-124]
     [java]     at org.h2.jdbc.JdbcPreparedStatement.executeBatch(JdbcPreparedStatement.java:1082)
     [java]     at org.hibernate.jdbc.BatchingBatcher.doExecuteBatch(BatchingBatcher.java:70)
     [java]     at org.hibernate.jdbc.AbstractBatcher.executeBatch(AbstractBatcher.java:268)
     [java]     ... 37 more
----

I'll try to see what are the differences between the two accounts.

=== 2011-09-15

So the problem is that the underlying h2 database does not contain an entry for
the `admin` user. Asked on IRC (#jbpm, irc.codehaus.org), the conclusion was
that this is a bug, created JIRA ticket:
https://issues.jboss.org/browse/JBPM-3356

In the meantime, I created a user `john` on the Alfresco server so I can
progress further.

I added code to be able to specify a workflow server url in the extension, with
that it's now possible to get a list of documents from the assigned task list.

The next step can be an extra checkbox on the save dialog to complete such a
task.

=== 2011-09-16

In ULX. Trying to add a checkbox to the save dialog that is unchecked and
disabled when not connected to a workflow server. I got a strange exception
during getting the workflow handler, so I looked up documentation on how can I
debug an extension from eclipse.

The extension part is described here:
http://wiki.services.openoffice.org/wiki/Java_and_OpenOffice.org#How_do_I_debug_Java_components_in_OpenOffice.org.3F

The Eclipse part is here: http://cedric.bosdonnat.free.fr/wordpress/?p=57

With that, I now have a workflow view in the file picker (when a workflow
server is configured), and I can also select if I want to complete the workflow
task when I save. -- It's unchecked and disabled when there is no workflow.

We discussed with Ivan, and decided that a process instance will "lock" a
document, so multiple processes can't own the same document.

The next step is to deal with decisions. Created a `Decision.bpmn` that
contains a human task, then a gateway that branches based on that human task.
That first task in the BPMN contains a form with two buttons and that sets the
`decision` string to `accept` or `reject`.

Once I had such a BPMN, I could see how to make a decision via the GWT console,
then I added support for this in the extension as well.

=== 2011-09-17

Did the tests requested by Gabor: on Linux x86_64 (Frugalware 1.5) and Windows XP 32bit (in kvm).

- OOo 3.3 on Linux is fine (that's what I develop for nowadays, as later relases are at the moment backwards-compatible)
- LO 3.4 on Linux: based on quick testing -- fine
- OOo 3.3 on Windows: does not work, I hit the issue described here: http://wiki.services.openoffice.org/wiki/Extensions_trouble_shooting
- LO 3.4 on Windows: based on quick testing -- fine

In all cases I used the official upstream binaries, either from Oracle or from TDF.

There was an issue with LO on Windows: adding a new server was not possible
till I increased the height of the window, but that's now fixed in SVN.

Did a change requested by Ivan: now files from the document server are
accessible, even if there is a workflow server connected. This is solved by a
new 'workflow' button which can list assigned documents. When there is a
workflow server, this view is the default -- when there is no workflow, then
the workflow button is disabled. I also added tooltips to the buttons, since
now there are 6 of them and just the 16x16px buttons are not that intuitive.

Version to test: lpsp-0.1-443-gc44534e.oxt

=== 2011-09-18

Looked at more related work. This time I did not search papers, but products.
First I had a look what Sharepoint supports. Introduction article:

http://office.microsoft.com/en-us/sharepoint-designer-help/create-a-workflow-HA010100591.aspx

First, I wasted time with installing Visual Studio Express on the client
machine (as it was mentioned as a dependency of 'Windows Workflow Foundation'),
already having Office, but later turned out that what I need is 'SharePoint
Designer 2007'. It's freely available here:

http://www.microsoft.com/download/en/details.aspx?id=21581

Here is a simple example, sending notifications to users when an item assigned to them is created or changed:
http://office.microsoft.com/en-us/sharepoint-designer-help/workflow-example-send-a-notification-message-HA010182908.aspx

There is still a lot of features to explore, so I don't declare 'checking
sharepoint' as done yet.

== 3rd week

=== 2011-09-19

Continuing Sharepoint evaluation. One problem I hit is that first I installed a
Hungarian Sharepoint Designer and that's a problem, as the translations are not
so trivial and the howtos are in English. Reinstalling English now.. :)

Once it's installed, it requires an updated .NET 3 framework (part of it is
Windows Workflow Foundation), it can be installed easily using the URL the
software provides.

Then I created my very first workflow, following this tutorial:

http://office.microsoft.com/en-us/sharepoint-designer-help/workflow-example-send-a-notification-message-HA010182908.aspx?CTT=3

Before I could test it, I had to configure outgoing email, as described here:

http://technet.microsoft.com/en-us/library/cc263462%28office.12%29.aspx

( What is not described there: the SharePoint Central Administration Web site
is at http://vmiklos-sp:31120/default.aspx )

Now everything looks fine, except that I don't get the email. I'll figure out
what's the problem tomorrow.

=== 2011-09-20

Continuing of the evaluation of Sharepoint/Word.

OK, after a few debugging, it turns out there were two problems:

- there is an internal sharepoint user called 'admin', while the one I'm
  logging in is 'Administrator', and they are not the same. When changing the
  workflow to 'Administrator', the server tries to send an email
- I had to configure the firewall of the host machine to accept SMTP
  connections from the virtual machines

With that, I have a working sharepoint workflow example! :)

(The workflow model consists of 3 files, they are in SVN.)

Now that I have a clue how a workflow looks like in Sharepoint, I looked up
what usecases does it support:

- http://office.microsoft.com/en-us/word-help/manage-the-document-approval-process-using-a-workflow-HA010220203.aspx
  document approval process; supported features: approve, reject, reassign, request a change (for a group of decision makers)
- the Workflow feature of Word supports three use cases: approval, review, collecting signatures
- each use case supports a set of actors, messsage to the actors and a deadline
- the input of reassign or request change is an other actor and a deadline
- the whole history of the workflow is saved and can be viewed later

(The whole workflow process can only be started when the sharepoint server is a
trusted site, but that doesn't require https, if the site is a trusted one in
Internet Explorer.)

And that's it, as far as I see the user interface in Word doesn't really
support anything else (workflow-related).

It seems it does not support the followings:

- decoupling of the document and workflow server
- document masking
- standard workflow format (such as BPMN)

=== 2011-09-21

In ULX. Eclipse (the one that I use for extension development) once again
crashed, leaving a workspace behind that can't be loaded. (At least I gave up
recovering it after an hour.) The plugins are not installed in the workspace,
so no reinstall is needed, but configuring paths is necessary. Here are the
ones I use (it always take time to figure out):

- Path to SDK: /home/vmiklos/documents/bme/diploma1/ooo33-64/opt/openoffice.org/basis3.3/sdk
- Path to OOo installation: /home/vmiklos/documents/bme/diploma1/ooo33-64/opt/openoffice.org3

An other breakage: JBoss startup seems, to hang, in the log there are messages like:

----
Caused by: java.lang.NoClassDefFoundError: org/jboss/threads/ArrayQueue
Caused by: java.lang.ClassNotFoundException: org.jboss.threads.ArrayQueue
----

Once I re-created the jbpm workspace, that got fixed as well. Checklist after
re-creating jbpm workspace:

- update eclipse.ini (by default the memory limit is too low for it)
- copy in workflow configs to sample/evaluation/src/main/resources/
- copy in jar files for each workflow to jboss-5.1.0.GA/server/default/lib/

With this, I have a working jbpm working environment again.

Poking group assignment. Here is a summary:

http://www.jboss.com/products/jbpm/docs/faq/#groupassignment

The workflow is that group tasks are claimed (converted to personal tasks), and
then completed or released.

First I implemented helper methods in the workflow handler (they access the
REST API of jbpm), then added user interface supports for the following
features:

- list group documents
- claim a document (take)
- release a document ("assign back")

=== 2011-09-22

Wrote up a more detailed sharepoint workflow analysis, sent it as an email.

Improved the 'Save As' dialog a bit: if you type `test` as filename and select
the doc filter, then it autocompletes the filename to `test.doc`.

Looked at Alfresco sharepoint module source code:

http://svn.alfresco.com/repos/alfresco-open-mirror/alfresco/HEAD/root/modules/sharepoint/amp/source/java/org/alfresco/module/vti/web/ws/CheckInFileEndpoint.java

Here the execute() method parses the pageUrl and comment fields from the soap
request, but ignores the CheckinType, that's why sharepoint checkins always
have the same type (the default is apparently 'major').

Version to test: lpsp-0.1-466-gc79bb46.oxt

=== 2011-09-23

I spent tonight with evaluation Alfresco's workflow support.

A good starting point is here: http://wiki.alfresco.com/wiki/Workflow

- it supports jbpm-jpdl (not the newer jbpm-bpmn2), also a newer 3.4.e introduces an own "activiti" engine for BPMN 2.0 support
- manual start of a set of predefinied workflows (as in Word) is possible using the web interface:

  * adhoc: Enables you to assign a task to a single user
  * group review & approve: Enables you to set up review and approval of content, assigning the workflow task to a single group
  * parallel review & approve: Enables you to set up review and approval of content, assigning the workflow task to multiple users.
  * pooled review & approve: Enables you to set up review and approval of content, assigning the workflow task to multiple users. One user can take ownership of the task at a time, completing it or returning it to the pool to be claimed by another user associated with the task.
  * review & approve: Enables you to set up review and approval of content, assigning the workflow task to a single user

( More here: http://www.alfresco.com/help/34/community/sharehelp/tasks/library-item-assign-workflow.html )

I've tried out the "review & approve" one, works as expected. During edit you
see the id of the workflow and using that id it's possible to see the history
of a workflow. Haven't figured out how to list all completed workflow, though.

Using jPDL3 (from jBPM3) it's also possible to define custom workflows, given
that I already spent time on jBPM5 already, I did not check this feature in
detail.

What I also wanted to check: does Alfresco support workflows in its Sharepoint
interface? It seems when opening a document from an Alfresco server in Word,
the Workflow menu item disappears, so that's not supported.

=== 2011-09-24

Installed liferay:
http://www.liferay.com/community/wiki/-/wiki/Main/Quick+Installation+Instructions
The version I've tried: liferay-portal-tomcat-6.0.6-20110225

Once the download and unzip is ready, the internal tomcat can be started. It
has a 'Document Library' feature, which is similar to the one Sharepoint and
Alfresco provides.

The Document Library publishes the contents via WebDAV, so basic file
operations (open, save) are simple from an external application as well. It
also supports versioning, document metadata. It seems advanced Sharepoint-like
actions like commit message during checkin is not supported.

Regarding workflow engine, it supports jBPM3 and Kaleo workflow engines:

http://www.liferay.com/web/jonas.yuan/blog/-/blogs/applying-workflow-on-any-assets-in-liferay-6

And a newer post:

http://www.liferay.com/web/juan.fernandez/blog/-/blogs/liferay-workflow-in-action

Given that Kaleo is the default, I wanted to try out that one. Unfortunately,
the necessary war file is not mirrored, and the only source (
http://liferay.cignex.com/palm_tree/book/0387/chapter09/kaleo-web-6.0.2.1.war )
is not reachable at the moment -- connection times out.

=== 2011-09-25

Then it turned out that the Kaleo engine is part of the default installation.

( Documentation for jBPM3:
http://www.liferay.com/community/wiki/-/wiki/Main/How+to+Set+Up+JBPM+with+Liferay
http://sourceforge.net/projects/jbpm/files/jBPM%203/jbpm-3.1.2/ )

There is a builtin sample for a simple review of document changes, I tried
that. It can be configured at 'Control Panel' -> 'Workflow Configuration'.
There I set 'Document Library Document': choosed 'Single Approver' instead of
'Default'.

With this, when a new version of the document is uploaded, it's possible to
'Submit as Draft' or 'Submit for Publication'. If the later is selected, the
status of the new version will be pending, also a new item in 'My Workflow
Tasks' appears in the 'Assigned to My Roles' section. (By default any
administrator has the role to review documents.) Once I choose 'Assign to Me',
it's moved to 'Assgigned to Me' and then choosing 'Approve' moves it to the
list of completed tasks.

The workflows here also have a 'Due Date' property, it's also possible -- as an
administrator -- to assign tasks to other users.

Needless to say, there are no Office integration in Liferay, except the WebDAV
interface.

== 4th week

=== 2011-09-26

Worked on document masking. My idea is that a document can contain named
sections, and these names can be mapped to the workflow node names.

So given that:

- the document contains named sections (this is true in case of ODF documents,
  Word does not support them, so the document is imported with generated
  section names like 'Convert 1')
- the section names are the same as the document workflow node names

The task of the extension is to:

- make sure only the current section is editable (set everything else to protected)
- undo these changes before save
- hide the protect/unprotect actions from the user

First I read up on the sections UNO API:

- Introduction:
  http://wiki.services.openoffice.org/wiki/Documentation/DevGuide/Text/Text_Sections
- Relevant interfaces: XTextSectionsSupplier, XPropertySet, TextSection
- To iterate over sections: XIndexAccess, XNamed
- To let the document be unmodified after touching the protected sections: XModifiable

Detailed documentation about these interfaces can be found in the
http://api.libreoffice.org/[LibreOffice API Documentation].

=== 2011-09-27

Worked on bugfixes:

- the document was assumed to be part of a task when there were a workflow server available
- all sections was disabled when there was no matching section name (compared to active node name)
- fixed 'save as' when creating a new file and workflow server is configured
- fixed default directory when using 'save as' and workflow server was configured
- fixed 'save' to call 'save as' when the handled document is not yet saved to the document server

Version to test: lpsp-0.1-484-ge35aa3a.oxt

=== 2011-09-28

In ULX. Started working on the 'audit log' feature. The idea is:

- search what jbpm api can be used to check if the user is an admin (only they can look at audit logs)
- search what jbpm api can be used to retrieve already completed workflows
- once a completed workflow is selected, a dialog similar to the document version history could describe the workflow history (columns: when, who, where did what)

It seems the process history is problematic on jBPM 5.1 at the moment:
http://community.jboss.org/thread/152989

Relevant JIRA tickets:
- https://issues.jboss.org/browse/BPMC-68
- https://issues.jboss.org/browse/JBPM-3069

And indeed no HistoryService is mentioned during boot:

----
$ grep DiscoverServices jboss-5.1.0.GA/server/default/log/server.log
2011-09-28 09:39:03,607 INFO  [STDOUT] (main) 09:39:03,607 INFO  [DiscoverServices] beging searching for services ...
2011-09-28 09:39:03,932 INFO  [STDOUT] (main) 09:39:03,932 INFO  [DiscoverServices] checking ErraiApp.properties for configured types ...
----

Digging deeper, it prints where does it search for services:

----
2011-09-28 15:02:25,026 INFO  [STDOUT] (main) 15:02:25,026 INFO  [ConfigUtil]  -> /home/vmiklos/documents/bme/diploma1/jbpm/jbpm-installer/jboss-5.1.0.GA/server/default/deploy/jbpm-gwt-console.war/WEB-INF/classes
----

in that WEB-INF folder, there is a lib folder as well, If I copy
jbpm-console-integration-4.4.jar there (which is for jBPM4, and provides
HistoryService), then I get:

----
2011-09-28 15:29:46,184 INFO  [STDOUT] (HDScanner) 15:29:46,184 INFO  [DiscoverServices] discovered service: org.jbpm.integration.console.services.HistoryService
2011-09-28 15:29:46,189 ERROR [STDERR] (HDScanner) com.google.inject.internal.ComputationException: com.google.inject.internal.ComputationException: java.lang.NoClassDefFoundError: Lorg/jbpm/api/ProcessEngine;
----

so it finds the service, but can't load it - the NoClassDefFoundError is due to
the depend on jBPM4.

Read the history chapter of the jBPM5 doc: http://docs.jboss.org/jbpm/v5.1/userguide/ch07.html#d0e2836

Then I had the chance to talk to krisv on IRC (main developer of jBPM), he confirmed:

----
17:00 < krisv> vmiklos: the history view is not (yet) supported in jBPM5
17:01 < krisv> vmiklos: there is a history log (as just by the process instance management and reporting parts), but the generation of a history view is not implemented
17:02 < vmiklos> krisv: uhm, so the best if i log it to some sql, then access sql directly, instead of using the rest api?
17:02 < krisv> vmiklos: the logging is already done if you configure a history logger, the REST api for history just doesn't work
17:03 < vmiklos> ok, thanks
17:04 < krisv> vmiklos: if you want to contribute the HistoryService? ;)
----

He also gave a few source code pointers:

- the old jBPM4 code that isn't ported to jBPM5: http://anonsvn.jboss.org/repos/jbpm/jbpm4/trunk/integration/console/src/main/java/org/jbpm/integration/console/services/
- jBPM5 code that logs history data: https://github.com/droolsjbpm/jbpm/blob/master/jbpm-bam/src/main/java/org/jbpm/process/audit/ProcessInstanceDbLog.java

Discussed with Ivan: I'll first work on starting new workflows, as the rest api
supports that already, then once I'm ready with that, I'll look into the above,
ideally should not take more than a week to implement.

TODO:

- feature from spec: storing audit log + ui for it in the extension
- new feature: make it possible to start a workflow: once the document is
  opened, a menu item to start a workflow, a dialog appears to choose a
  workflow from a combo box
- bug: document url is not accessible after completing the first human task
