= Diploma 1 log

== 1st week

Too busy, first meeting scheduled on 2nd week.

== 2nd week

=== 2011-02-14

I sent back the two patches I created during projlab2:

http://article.gmane.org/gmane.linux.kernel.device-mapper.devel/13399

It turned out (in a reply) that the whole round-robin code is RHEL5-specific,
it does not present in RHEl6/upstream. (Need to find out why.)

We agreed on the meeting that this week I'll evaluate dm-raid to see how mature
it is. We also agreed that I'll visit ULX 1-2 times a week this semester.

I installed RHEL6 in a virtual machine, spent a lot of time with downloading
the i386 version as first I picked up the x86_64 one...

Asked Jonathan about possible task list for dm-raid, got it:

http://article.gmane.org/gmane.linux.kernel.device-mapper.devel/13400

=== 2011-02-15

Asked Jonathan for newest dm-raid kernel patches & userspace tools. dm-raid is
a single commit in upstream (drivers/md/dm-raid.c), looks like the latest
version is in some private quilt tree. The userspace part is not yet part of
lvm2, a prototype is available in perl. Available here:

http://article.gmane.org/gmane.linux.kernel.device-mapper.devel/13418

=== 2011-02-16

Trying to find out dm-raid status on RHEL6 kernel:

----
$ wget ftp://ftp.redhat.com/redhat/linux/enterprise/6Server/en/os/SRPMS/kernel-2.6.32-71.el6.src.rpm
$ rpm -Uvh kernel-2.6.32-71.el6.src.rpm 2>&1 | grep -v mockb
$ cd ~/rpmbuild/SPECS
$ rpmbuild -bp --target=`uname -m` kernel.spec 2>&1 | tee prep.log
----

The source package is called kernel, it was kernel-2.6 in RHEL5.

Configuring the install media to be a source repo for `yum install` also
changed, now those .repo files live under /etc/yum.repos.d, not
/etc/yum/repos.d. After this, build-dependencies for kernel build could be
installed and prep went fine.

The rest of the prepare was the same as on RHEL5:

----
$ cd ~/rpmbuild/BUILD/kernel-2.6.32-71.el6/linux-2.6.32-71.el6.i686
$ perl -p -i -e "s/^EXTRAVERSION.*/EXTRAVERSION = -71.el6/" Makefile

$ cp /boot/symvers-2.6.32-71.el6.i686.gz .
$ gunzip symvers-2.6.32-71.el6.i686.gz
$ mv symvers-2.6.32-71.el6.i686 Module.symvers

$ make prepare
$ make modules_prepare
$ make M=drivers/md
# cp drivers/md/*.ko /lib/modules/2.6.18-194.el5/extra
# depmod -a
----

The sad news is that dm-raid.c is not part of the RHEL6 kernel:

----
root@diploma1:~# modinfo dm-raid
ERROR: modinfo: could not find module dm-raid
----

so it's possible to:

- cherry-pick the dm-raid.c commit from upstream + apply Jonathan's patches or
- install rawhide where they have kernel-2.6.38rc5 (including dm-raid.c) + only
  apply the patches there

Given that I have RHEL6 install at the moment, I'm trying the first.

The cherry-picked patch applies, but build fails:

----
  CC [M]  drivers/md/dm-raid.o
drivers/md/dm-raid.c:61: error: field 'callbacks' has incomplete type
drivers/md/dm-raid.c: In function 'context_alloc':
drivers/md/dm-raid.c:119: error: implicit declaration of function 'mddev_init'
drivers/md/dm-raid.c:133: error: implicit declaration of function 'md_rdev_init'
drivers/md/dm-raid.c: In function 'parse_raid_params':
drivers/md/dm-raid.c:347: error: implicit declaration of function 'raid5_set_cache_size'
drivers/md/dm-raid.c: In function 'do_table_event':
drivers/md/dm-raid.c:381: error: 'struct mddev_s' has no member named 'event_work'
drivers/md/dm-raid.c:381: warning: type defaults to 'int' in declaration of '__mptr'
drivers/md/dm-raid.c:381: warning: initialization from incompatible pointer type
drivers/md/dm-raid.c:381: error: 'struct mddev_s' has no member named 'event_work'
drivers/md/dm-raid.c: In function 'raid_is_congested':
drivers/md/dm-raid.c:388: warning: type defaults to 'int' in declaration of '__mptr'
drivers/md/dm-raid.c:388: warning: initialization from incompatible pointer type
drivers/md/dm-raid.c:390: error: implicit declaration of function 'md_raid5_congested'
drivers/md/dm-raid.c: In function 'raid_unplug':
drivers/md/dm-raid.c:395: warning: type defaults to 'int' in declaration of '__mptr'
drivers/md/dm-raid.c:395: warning: initialization from incompatible pointer type
drivers/md/dm-raid.c:397: error: implicit declaration of function 'md_raid5_unplug_device'
drivers/md/dm-raid.c: In function 'raid_ctr':
drivers/md/dm-raid.c:475: error: 'struct mddev_s' has no member named 'event_work'
drivers/md/dm-raid.c:475: error: 'struct mddev_s' has no member named 'event_work'
drivers/md/dm-raid.c:475: error: 'struct mddev_s' has no member named 'event_work'
drivers/md/dm-raid.c:480: error: implicit declaration of function 'md_run'
drivers/md/dm-raid.c:491: error: implicit declaration of function 'dm_table_add_target_callbacks'
drivers/md/dm-raid.c: In function 'raid_dtr':
drivers/md/dm-raid.c:506: error: implicit declaration of function 'md_stop'
drivers/md/dm-raid.c: In function 'raid_presuspend':
drivers/md/dm-raid.c:647: error: implicit declaration of function 'md_stop_writes'
drivers/md/dm-raid.c: In function 'raid_postsuspend':
drivers/md/dm-raid.c:654: error: implicit declaration of function 'mddev_suspend'
drivers/md/dm-raid.c: In function 'raid_resume':
drivers/md/dm-raid.c:661: error: implicit declaration of function 'mddev_resume'
make[1]: *** [drivers/md/dm-raid.o] Error 1
make: *** [_module_drivers/md] Error 2
----

So now I'm installing rawhide. Not rawhide actually, but Fedora Branched
(pre-Fedora15), which is supposed a bit more stable than rawhide and contains a
new enough kernel as well - following the instructions from here:

http://fedoraproject.org/wiki/Releases/Branched#Yum_update_from_previous_official_release

A few tricks were needed to get a bootable system after upgrade (disable
selinux, blacklist microcode kernel module), but that's probably due to
'Branched' being pre-alpha.

The dm-raid code is here:

----
root@diploma1-f:~# modinfo dm-raid
filename:       /lib/modules/2.6.38-0.rc4.git7.1.fc15.i686.PAE/kernel/drivers/md/dm-raid.ko
license:        GPL
author:         Neil Brown <dm-devel@redhat.com>
alias:          dm-raid6
alias:          dm-raid5
alias:          dm-raid4
description:    device-mapper raid4/5/6 target
srcversion:     B900F48156096E136BB8CD9
depends:        raid456
vermagic:       2.6.38-0.rc4.git7.1.fc15.i686.PAE SMP mod_unload 686 
----

Let's try out, based on:

http://article.gmane.org/gmane.linux.kernel.device-mapper.devel/12890

----
# ~vmiklos/dm-raid-patches/gime_raid.pl raid4 /dev/sd[bcdef]1
RAID type    : raid4
Block devices: /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1 /dev/sdf1
Device size  : 770868BB
----

and it hangs here...

In an other shell:

----
# dmsetup ls
raid    (253, 2)
vg_diploma1f-lv_swap    (253, 1)
vg_diploma1f-lv_root    (253, 0)
----

So it does create something, but definitely not perfect:

----
# strace -p $(pidof dmsetup)
Process 1144 attached - interrupt to quit
semop(32768, {{0, 0, 0}}, 1
----

But I guess it does not worth doing more debugging before applying Jonathan's
patches.

=== 2011-02-17

Let's do that:

----
$ wget http://download.fedora.redhat.com/pub/fedora/linux/development/15/source/SRPMS/kernel-2.6.38-0.rc4.git0.2.fc15.src.rpm
$ rpm -Uvh kernel-2.6.38-0.rc4.git0.2.fc15.src.rpm 2>&1 | grep -v mockb
$ cd ~/rpmbuild/SPECS
# yum install xmlto asciidoc elfutils-devel 'perl(ExtUtils::Embed)' # build-depends for kernel
$ rpmbuild -bp --target=`uname -m` kernel.spec 2>&1 | tee prep.log
----

Then continue the build manually:

----
$ cd ~/rpmbuild/BUILD/kernel-2.6.37.fc15/linux-2.6.37.i686
$ perl -p -i -e "s/^EXTRAVERSION.*/EXTRAVERSION = -0.rc4.git7.1.fc15.i686.PAE/" Makefile

$ cp /usr/src/kernels/2.6.38-0.rc4.git7.1.fc15.i686.PAE/Module.symvers .

$ make prepare
$ make modules_prepare
$ make M=drivers/md
# cp drivers/md/*.ko /lib/modules/2.6.38-0.rc4.git7.1.fc15.i686.PAE/extra/
# depmod -a
----

Apply the patches:

----
$ git quiltimport --author "Jonathan Brassow <jbrassow@redhat.com>" --patches ~/dm-raid-patches/
----

Build, install and reload the modules, then try it:

----
# ~vmiklos/dm-raid-patches/gime_raid.pl raid4 /dev/sd[bcdef]1
RAID type    : raid4
Block devices: /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1 /dev/sdf1
Device size  : 770868BB
# ls /dev/mapper/
control  raid  vg_diploma1f-lv_root  vg_diploma1f-lv_swap
----

No hanging!

However almost anything else fails. Here is what I tried:

(I reverted the virtual machine to a snapshot before each attempt.)

Creating a raid1:

----
# ~vmiklos/dm-raid-patches/gime_raid.pl raid1 /dev/sd[bc]1
RAID type    : raid1
Block devices: /dev/sdb1 /dev/sdc1
Device size  : 192717BB

Message from syslogd@diploma1-f at Feb 17 11:19:57 ...
 kernel:[ 1395.143044] Oops: 0000 [#1] SMP

(...)

sh: line 1:  4209 Done                    echo 0 192717 raid raid1 0 2 - /dev/sdb1 - /dev/sdc1
      4210 Killed                  | dmsetup create raid
Failed to create "raid":
  0 192717 raid raid1 0 2 - /dev/sdb1 - /dev/sdc1
----

dmesg:

----
[ 1269.709043] bio: create slab <bio-1> at 1
[ 1269.733414] md/raid1:mdX: not clean -- starting background reconstruction
[ 1269.734568] md/raid1:mdX: active with 2 out of 2 mirrors
[ 1269.752416] BUG: unable to handle kernel NULL pointer dereference at 000001f4
[ 1269.753039] IP: [<c070c3d0>] md_integrity_register+0x29/0xdc
[ 1269.753039] *pdpt = 000000000c77c001 *pde = 000000000f5be067 *pte = 0000000000000000 
[ 1269.753039] Oops: 0000 [#1] SMP 
[ 1269.753039] last sysfs file: /sys/module/raid1/initstate
[ 1269.753039] Modules linked in: dm_raid raid1 raid456 async_raid6_recov async_pq raid6_pq async_xor xor async_memcpy async_tx sunrpc ip6t_REJECT nf_conntrack_ipv6 nf_defrag_ipv6 ip6table_filter ip6_tables snd_ens1371 gameport snd_rawmidi snd_ac97_codec ac97_bus snd_seq snd_seq_device snd_pcm snd_timer ppdev vmw_balloon snd pcnet32 mii soundcore snd_page_alloc i2c_piix4 parport_pc i2c_core parport ipv6 mptspi mptscsih mptbase scsi_transport_spi [last unloaded: raid456]
[ 1269.753039] 
[ 1269.753039] Pid: 4227, comm: dmsetup Not tainted 2.6.38-0.rc4.git7.1.fc15.i686.PAE #1 440BX Desktop Reference Platform/VMware Virtual Platform
[ 1269.753039] EIP: 0060:[<c070c3d0>] EFLAGS: 00010246 CPU: 0
[ 1269.753039] EIP is at md_integrity_register+0x29/0xdc
[ 1269.753039] EAX: 00000000 EBX: cf8dd398 ECX: 00000000 EDX: 00000000
[ 1269.753039] ESI: cf8dd00c EDI: 00000000 EBP: cc79dd4c ESP: cc79dd34
[ 1269.753039]  DS: 007b ES: 007b FS: 00d8 GS: 00e0 SS: 0068
[ 1269.753039] Process dmsetup (pid: 4227, ti=cc79c000 task=cf8e25b0 task.ti=cc79c000)
[ 1269.753039] Stack:
[ 1269.753039]  cc780f68 cc780f68 cf8dd01c cf8dd00c cc780f68 0000000c cc79dd74 d10b7d46
[ 1269.753039]  d10ba952 d10ba775 00000002 00000002 000000e0 cf8dd01c cf8dd00c cf8dd01c
[ 1269.753039]  cc79ddfc c070f8cf 00000001 c098c29a 00000001 00000021 c040b453 cf8dd394
[ 1269.753039] Call Trace:
[ 1269.753039]  [<d10b7d46>] run+0x24c/0x256 [raid1]
[ 1269.753039]  [<c070f8cf>] md_run+0x4f0/0x7ab
[ 1269.753039]  [<c040b453>] ? do_softirq+0x8c/0x92
[ 1269.753039]  [<c0420d64>] ? smp_apic_timer_interrupt+0x6b/0x78
[ 1269.753039]  [<c0435ad9>] ? __might_sleep+0x29/0xe4
[ 1269.753039]  [<c042f5a4>] ? should_resched+0xd/0x27
[ 1269.753039]  [<c07e603e>] ? _cond_resched+0xd/0x21
[ 1269.753039]  [<d10f5ff7>] raid_ctr+0x8b4/0x8d4 [dm_raid]
[ 1269.753039]  [<c07177f5>] dm_table_add_target+0x165/0x202
[ 1269.753039]  [<c04d4f7f>] ? vfree+0x25/0x27
[ 1269.753039]  [<c071715b>] ? alloc_targets+0x8c/0xb1
[ 1269.753039]  [<c071a05c>] table_load+0x233/0x242
[ 1269.753039]  [<c0719aa8>] dm_ctl_ioctl+0x1af/0x1ed
[ 1269.753039]  [<c043474f>] ? pick_next_task_fair+0x85/0x8d
[ 1269.753039]  [<c0719e29>] ? table_load+0x0/0x242
[ 1269.753039]  [<c07198f9>] ? dm_ctl_ioctl+0x0/0x1ed
[ 1269.753039]  [<c04f9c4f>] do_vfs_ioctl+0x451/0x482
[ 1269.753039]  [<c0491ca0>] ? __call_rcu+0xdb/0xe1
[ 1269.753039]  [<c0501713>] ? mntput_no_expire+0x28/0xbd
[ 1269.753039]  [<c05017c6>] ? mntput+0x1e/0x20
[ 1269.753039]  [<c04f4f4f>] ? path_put+0x1a/0x1d
[ 1269.753039]  [<c04f9cc7>] sys_ioctl+0x47/0x60
[ 1269.753039]  [<c040969f>] sysenter_do_call+0x12/0x28
[ 1269.753039] Code: 5d c3 55 89 e5 57 56 53 83 ec 0c 3e 8d 74 26 00 89 c6 8b 5e 10 8d 40 10 89 45 f0 31 c0 3b 5d f0 0f 84 b0 00 00 00 8b 56 30 31 ff <83> ba f4 01 00 00 00 0f 85 9e 00 00 00 eb 38 8b 43 6c a8 02 75 
[ 1269.753039] EIP: [<c070c3d0>] md_integrity_register+0x29/0xdc SS:ESP 0068:cc79dd34
[ 1269.753039] CR2: 00000000000001f4
[ 1269.898378] ---[ end trace 49f34abab1d4a1b8 ]---
----

Creating and then deleting a raid4:

----
root@diploma1-f:~# ~vmiklos/dm-raid-patches/gime_raid.pl raid4 /dev/sd[bcdef]1
RAID type    : raid4
Block devices: /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1 /dev/sdf1
Device size  : 770868BB

root@diploma1-f:~# dmsetup remove raid
Killed
----

dmesg:

----
[ 1289.594670] bio: create slab <bio-1> at 1
[ 1289.617603] md/raid:mdX: not clean -- starting background reconstruction
[ 1289.623386] md/raid:mdX: device sdf1 operational as raid disk 4
[ 1289.634279] md/raid:mdX: device sde1 operational as raid disk 3
[ 1289.634889] md/raid:mdX: device sdd1 operational as raid disk 2
[ 1289.635479] md/raid:mdX: device sdc1 operational as raid disk 1
[ 1289.636071] md/raid:mdX: device sdb1 operational as raid disk 0
[ 1289.661945] md/raid:mdX: allocated 5265kB
[ 1289.663995] md/raid:mdX: raid level 5 active with 5 out of 5 devices, algorithm 4
[ 1289.665539] RAID conf printout:
[ 1289.665630]  --- level:5 rd:5 wd:5
[ 1289.665742]  disk 0, o:1, dev:sdb1
[ 1289.665759]  disk 1, o:1, dev:sdc1
[ 1289.665765]  disk 2, o:1, dev:sdd1
[ 1289.665770]  disk 3, o:1, dev:sde1
[ 1289.665776]  disk 4, o:1, dev:sdf1
[ 1289.685823] md: resync of RAID array mdX
[ 1289.686486] md: minimum _guaranteed_  speed: 1000 KB/sec/disk.
[ 1289.687117] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for resync.
[ 1289.701594] md: using 128k window, over a total of 96256 blocks.
[ 1289.892256] attempt to access beyond end of device
[ 1289.893552] sdc1: rw=0, want=193160, limit=192717
[ 1289.895278] attempt to access beyond end of device
[ 1289.895768] sdf1: rw=0, want=193160, limit=192717
[ 1289.896795] attempt to access beyond end of device
[ 1289.897354] sde1: rw=0, want=193160, limit=192717
[ 1289.897991] attempt to access beyond end of device
[ 1289.898565] sdd1: rw=0, want=193160, limit=192717
[ 1289.899524] attempt to access beyond end of device
[ 1289.900051] sdb1: rw=0, want=193160, limit=192717
[ 1289.901523] md/raid:mdX: Disk failure on sdf1, disabling device.
[ 1289.901528] md/raid:mdX: Operation continuing on 4 devices.
[ 1289.909029] md/raid:mdX: Disk failure on sde1, disabling device.
[ 1289.909033] md/raid:mdX: Operation continuing on 3 devices.
[ 1289.917651] md/raid:mdX: Disk failure on sdd1, disabling device.
[ 1289.917656] md/raid:mdX: Operation continuing on 2 devices.
[ 1289.918748] md/raid:mdX: Disk failure on sdc1, disabling device.
[ 1289.918752] md/raid:mdX: Operation continuing on 1 devices.
[ 1289.933445] md/raid:mdX: Disk failure on sdb1, disabling device.
[ 1289.933449] md/raid:mdX: Operation continuing on 0 devices.
[ 1289.936280] Buffer I/O error on device dm-2, logical block 192673
[ 1289.937184] Buffer I/O error on device dm-2, logical block 192672
[ 1289.954961] Buffer I/O error on device dm-2, logical block 192673
[ 1289.955619] Buffer I/O error on device dm-2, logical block 192672
[ 1289.956650] Buffer I/O error on device dm-2, logical block 192712
[ 1289.960572] Buffer I/O error on device dm-2, logical block 192713
[ 1289.961338] Buffer I/O error on device dm-2, logical block 192712
[ 1289.962174] Buffer I/O error on device dm-2, logical block 192713
[ 1289.963016] Buffer I/O error on device dm-2, logical block 0
[ 1289.977325] Buffer I/O error on device dm-2, logical block 1
[ 1290.812860] md: mdX: resync done.
[ 1290.813983] md: checkpointing resync of mdX.
[ 1290.822997] md: resync of RAID array mdX
[ 1290.831231] md: minimum _guaranteed_  speed: 1000 KB/sec/disk.
[ 1290.832595] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for resync.
[ 1290.833594] md: using 128k window, over a total of 96256 blocks.
[ 1290.834244] md: resuming resync of mdX from checkpoint.
[ 1290.834877] md: mdX: resync done.
[ 1290.850001] RAID conf printout:
[ 1290.850062]  --- level:5 rd:5 wd:0
[ 1290.850070]  disk 0, o:0, dev:sdb1
[ 1290.850076]  disk 1, o:0, dev:sdc1
[ 1290.850081]  disk 2, o:0, dev:sdd1
[ 1290.850086]  disk 3, o:0, dev:sde1
[ 1290.850091]  disk 4, o:0, dev:sdf1
[ 1293.215726] BUG: sleeping function called from invalid context at arch/x86/mm/fault.c:1081
[ 1293.216017] in_atomic(): 0, irqs_disabled(): 1, pid: 4250, name: dmsetup
[ 1293.216017] Pid: 4250, comm: dmsetup Not tainted 2.6.38-0.rc4.git7.1.fc15.i686.PAE #1
[ 1293.216017] Call Trace:
[ 1293.216017]  [<c0435b8d>] ? __might_sleep+0xdd/0xe4
[ 1293.216017]  [<c07ea191>] ? do_page_fault+0x179/0x30c
[ 1293.216017]  [<c0465112>] ? tick_dev_program_event+0x2f/0x137
[ 1293.216017]  [<c04e0b72>] ? kmem_cache_free+0x67/0x94
[ 1293.216017]  [<c0535dfd>] ? release_sysfs_dirent+0x79/0x8c
[ 1293.216017]  [<c07ea018>] ? do_page_fault+0x0/0x30c
[ 1293.216017]  [<c07e7d97>] ? error_code+0x67/0x6c
[ 1293.216017]  [<c07e726b>] ? _raw_spin_lock_irqsave+0x15/0x27
[ 1293.216017]  [<c05c7d92>] ? __disk_unblock_events+0x23/0x9e
[ 1293.216017]  [<c042f5a4>] ? should_resched+0xd/0x27
[ 1293.216017]  [<c05c91bc>] ? disk_unblock_events+0x1b/0x1d
[ 1293.216017]  [<c0511052>] ? blkdev_put+0xbb/0xe7
[ 1293.216017]  [<c0716f35>] ? close_dev+0x30/0x3a
[ 1293.216017]  [<c0716f61>] ? dm_put_device+0x22/0x33
[ 1293.216017]  [<d10f56e7>] ? context_free+0x58/0x73 [dm_raid]
[ 1293.216017]  [<d10f5740>] ? raid_dtr+0x3e/0x41 [dm_raid]
[ 1293.216017]  [<c0717550>] ? dm_table_destroy+0x5b/0xcf
[ 1293.216017]  [<c0469a28>] ? arch_local_irq_save+0x12/0x17
[ 1293.216017]  [<c0715ae3>] ? __dm_destroy+0xfa/0x1c2
[ 1293.216017]  [<c0716412>] ? dm_destroy+0x12/0x14
[ 1293.216017]  [<c071a146>] ? dev_remove+0xdb/0xe5
[ 1293.216017]  [<c05dae00>] ? copy_to_user+0x12/0x4b
[ 1293.216017]  [<c0719aa8>] ? dm_ctl_ioctl+0x1af/0x1ed
[ 1293.216017]  [<c058fae7>] ? newary+0x10a/0x11c
[ 1293.216017]  [<c071a06b>] ? dev_remove+0x0/0xe5
[ 1293.216017]  [<c07198f9>] ? dm_ctl_ioctl+0x0/0x1ed
[ 1293.216017]  [<c04f9c4f>] ? do_vfs_ioctl+0x451/0x482
[ 1293.216017]  [<c0491ca0>] ? __call_rcu+0xdb/0xe1
[ 1293.216017]  [<c0501713>] ? mntput_no_expire+0x28/0xbd
[ 1293.216017]  [<c05017c6>] ? mntput+0x1e/0x20
[ 1293.216017]  [<c04f4f4f>] ? path_put+0x1a/0x1d
[ 1293.216017]  [<c04f9cc7>] ? sys_ioctl+0x47/0x60
[ 1293.216017]  [<c040969f>] ? sysenter_do_call+0x12/0x28
[ 1293.216017] BUG: unable to handle kernel NULL pointer dereference at 0000080c
[ 1293.216017] IP: [<c07e726b>] _raw_spin_lock_irqsave+0x15/0x27
[ 1293.216017] *pdpt = 000000000f7cb001 *pde = 000000000c661067 *pte = 0000000000000000 
[ 1293.216017] Oops: 0002 [#1] SMP 
[ 1293.216017] last sysfs file: /sys/devices/virtual/block/dm-2/range
[ 1293.216017] Modules linked in: dm_raid raid1 raid456 async_raid6_recov async_pq raid6_pq async_xor xor async_memcpy async_tx sunrpc ip6t_REJECT nf_conntrack_ipv6 nf_defrag_ipv6 ip6table_filter ip6_tables snd_ens1371 gameport snd_rawmidi snd_ac97_codec ac97_bus snd_seq snd_seq_device snd_pcm snd_timer ppdev vmw_balloon snd pcnet32 mii soundcore snd_page_alloc i2c_piix4 parport_pc i2c_core parport ipv6 mptspi mptscsih mptbase scsi_transport_spi [last unloaded: raid456]
[ 1293.216017] 
[ 1293.216017] Pid: 4250, comm: dmsetup Not tainted 2.6.38-0.rc4.git7.1.fc15.i686.PAE #1 440BX Desktop Reference Platform/VMware Virtual Platform
[ 1293.216017] EIP: 0060:[<c07e726b>] EFLAGS: 00010082 CPU: 0
[ 1293.216017] EIP is at _raw_spin_lock_irqsave+0x15/0x27
[ 1293.216017] EAX: 00000282 EBX: 0000080c ECX: 00000083 EDX: 00000100
[ 1293.216017] ESI: cf98be00 EDI: 00000001 EBP: cf5b9dfc ESP: cf5b9df8
[ 1293.216017]  DS: 007b ES: 007b FS: 00d8 GS: 00e0 SS: 0068
[ 1293.216017] Process dmsetup (pid: 4250, ti=cf5b8000 task=cfa77110 task.ti=cf5b8000)
[ 1293.216017] Stack:
[ 1293.216017]  00000800 cf5b9e18 c05c7d92 c042f5a4 0000080c cbc31400 cbc31410 00000083
[ 1293.216017]  cf5b9e20 c05c91bc cf5b9e34 c0511052 cda488c0 cccc5000 00000000 cf5b9e40
[ 1293.216017]  c0716f35 cda488c0 cf5b9e4c c0716f61 cccc5000 cf5b9e60 d10f56e7 cccc5000
[ 1293.216017] Call Trace:
[ 1293.216017]  [<c05c7d92>] __disk_unblock_events+0x23/0x9e
[ 1293.216017]  [<c042f5a4>] ? should_resched+0xd/0x27
[ 1293.216017]  [<c05c91bc>] disk_unblock_events+0x1b/0x1d
[ 1293.216017]  [<c0511052>] blkdev_put+0xbb/0xe7
[ 1293.216017]  [<c0716f35>] close_dev+0x30/0x3a
[ 1293.216017]  [<c0716f61>] dm_put_device+0x22/0x33
[ 1293.216017]  [<d10f56e7>] context_free+0x58/0x73 [dm_raid]
[ 1293.216017]  [<d10f5740>] raid_dtr+0x3e/0x41 [dm_raid]
[ 1293.216017]  [<c0717550>] dm_table_destroy+0x5b/0xcf
[ 1293.216017]  [<c0469a28>] ? arch_local_irq_save+0x12/0x17
[ 1293.216017]  [<c0715ae3>] __dm_destroy+0xfa/0x1c2
[ 1293.216017]  [<c0716412>] dm_destroy+0x12/0x14
[ 1293.216017]  [<c071a146>] dev_remove+0xdb/0xe5
[ 1293.216017]  [<c05dae00>] ? copy_to_user+0x12/0x4b
[ 1293.216017]  [<c0719aa8>] dm_ctl_ioctl+0x1af/0x1ed
[ 1293.216017]  [<c058fae7>] ? newary+0x10a/0x11c
[ 1293.216017]  [<c071a06b>] ? dev_remove+0x0/0xe5
[ 1293.216017]  [<c07198f9>] ? dm_ctl_ioctl+0x0/0x1ed
[ 1293.216017]  [<c04f9c4f>] do_vfs_ioctl+0x451/0x482
[ 1293.216017]  [<c0491ca0>] ? __call_rcu+0xdb/0xe1
[ 1293.216017]  [<c0501713>] ? mntput_no_expire+0x28/0xbd
[ 1293.216017]  [<c05017c6>] ? mntput+0x1e/0x20
[ 1293.216017]  [<c04f4f4f>] ? path_put+0x1a/0x1d
[ 1293.216017]  [<c04f9cc7>] sys_ioctl+0x47/0x60
[ 1293.216017]  [<c040969f>] sysenter_do_call+0x12/0x28
[ 1293.216017] Code: 0f 95 c0 0f b6 c0 c3 55 89 e5 3e 8d 74 26 00 e8 06 28 c8 ff 5d c3 55 89 e5 53 3e 8d 74 26 00 89 c3 e8 b0 27 c8 ff ba 00 01 00 00 <3e> 66 0f c1 13 38 f2 74 06 f3 90 8a 13 eb f6 5b 5d c3 55 89 e5 
[ 1293.216017] EIP: [<c07e726b>] _raw_spin_lock_irqsave+0x15/0x27 SS:ESP 0068:cf5b9df8
[ 1293.216017] CR2: 000000000000080c
[ 1293.216017] ---[ end trace 49f34abab1d4a1b8 ]---
----

Creating a raid4 and creating a filesystem on it:

----
root@diploma1-f:~# ~vmiklos/dm-raid-patches/gime_raid.pl raid4 /dev/sd[bcdef]1
RAID type    : raid4
Block devices: /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1 /dev/sdf1
Device size  : 770868BB

root@diploma1-f:~# mkfs.ext4 /dev/mapper/raid 
mke2fs 1.41.14 (22-Dec-2010)
----

and it hangs here.

dmesg:

----
[ 1270.954599] bio: create slab <bio-1> at 1
[ 1270.963550] md/raid:mdX: not clean -- starting background reconstruction
[ 1270.987463] md/raid:mdX: device sdf1 operational as raid disk 4
[ 1270.989895] md/raid:mdX: device sde1 operational as raid disk 3
[ 1270.990513] md/raid:mdX: device sdd1 operational as raid disk 2
[ 1270.991101] md/raid:mdX: device sdc1 operational as raid disk 1
[ 1270.992075] md/raid:mdX: device sdb1 operational as raid disk 0
[ 1271.028680] md/raid:mdX: allocated 5265kB
[ 1271.047135] md/raid:mdX: raid level 5 active with 5 out of 5 devices, algorithm 4
[ 1271.048513] RAID conf printout:
[ 1271.048604]  --- level:5 rd:5 wd:5
[ 1271.048749]  disk 0, o:1, dev:sdb1
[ 1271.048768]  disk 1, o:1, dev:sdc1
[ 1271.048773]  disk 2, o:1, dev:sdd1
[ 1271.048779]  disk 3, o:1, dev:sde1
[ 1271.048784]  disk 4, o:1, dev:sdf1
[ 1271.079401] md: resync of RAID array mdX
[ 1271.080482] md: minimum _guaranteed_  speed: 1000 KB/sec/disk.
[ 1271.081111] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for resync.
[ 1271.082639] md: using 128k window, over a total of 96256 blocks.
[ 1271.261775] attempt to access beyond end of device
[ 1271.262542] sdc1: rw=0, want=193160, limit=192717
[ 1271.263924] attempt to access beyond end of device
[ 1271.264467] sdf1: rw=0, want=193160, limit=192717
[ 1271.265172] attempt to access beyond end of device
[ 1271.265747] sde1: rw=0, want=193160, limit=192717
[ 1271.266436] attempt to access beyond end of device
[ 1271.266946] sdd1: rw=0, want=193160, limit=192717
[ 1271.267872] attempt to access beyond end of device
[ 1271.281551] sdb1: rw=0, want=193160, limit=192717
[ 1271.282992] md/raid:mdX: Disk failure on sdf1, disabling device.
[ 1271.282996] md/raid:mdX: Operation continuing on 4 devices.
[ 1271.284807] md/raid:mdX: Disk failure on sde1, disabling device.
[ 1271.284811] md/raid:mdX: Operation continuing on 3 devices.
[ 1271.285962] md/raid:mdX: Disk failure on sdd1, disabling device.
[ 1271.285966] md/raid:mdX: Operation continuing on 2 devices.
[ 1271.300746] md/raid:mdX: Disk failure on sdc1, disabling device.
[ 1271.300750] md/raid:mdX: Operation continuing on 1 devices.
[ 1271.302077] md/raid:mdX: Disk failure on sdb1, disabling device.
[ 1271.302081] md/raid:mdX: Operation continuing on 0 devices.
[ 1271.322206] Buffer I/O error on device dm-2, logical block 192673
[ 1271.323102] Buffer I/O error on device dm-2, logical block 192672
[ 1271.326465] Buffer I/O error on device dm-2, logical block 192672
[ 1271.338964] Buffer I/O error on device dm-2, logical block 192673
[ 1271.339820] Buffer I/O error on device dm-2, logical block 192712
[ 1271.340476] Buffer I/O error on device dm-2, logical block 192713
[ 1271.341118] Buffer I/O error on device dm-2, logical block 192712
[ 1271.341700] Buffer I/O error on device dm-2, logical block 192713
[ 1271.356296] Buffer I/O error on device dm-2, logical block 0
[ 1271.356867] Buffer I/O error on device dm-2, logical block 1
[ 1272.188477] md: mdX: resync done.
[ 1272.189634] md: checkpointing resync of mdX.
[ 1272.192828] md: resync of RAID array mdX
[ 1272.193363] md: minimum _guaranteed_  speed: 1000 KB/sec/disk.
[ 1272.194090] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for resync.
[ 1272.195083] md: using 128k window, over a total of 96256 blocks.
[ 1272.195723] md: resuming resync of mdX from checkpoint.
[ 1272.209475] md: mdX: resync done.
[ 1272.210697] RAID conf printout:
[ 1272.210709]  --- level:5 rd:5 wd:0
[ 1272.210716]  disk 0, o:0, dev:sdb1
[ 1272.210721]  disk 1, o:0, dev:sdc1
[ 1272.210726]  disk 2, o:0, dev:sdd1
[ 1272.210731]  disk 3, o:0, dev:sde1
[ 1272.210736]  disk 4, o:0, dev:sdf1
----

=== 2011-02-18

We had an in-person meeting with Gabor and Ivan:

- dm-mirror is the past, dm-raid is the future, there is good current MSc thesis topic in this area, we need something new
- given that I have some OpenOffice.org/LibreOffice experience, the new topic could be connected to that

Initial idea:

Alfresco is kind of an opensource alternative to MS Sharepoint (regarding
document handling), it can emulate MS sharepoint (ideally). There are MS Office
/ OOo extensions for Alfresco, probably using its native protocol. There is a
commercial (free as in beer) MS Sharepoint OOo extension by Oracle. Goal:
opensource alternative of this.

Once this is done, I could design and implement a similar plugin that can
communicate with an ESB for document handling (but this part will be discussed
in detail once the first part is done).

Need to look after / try out:

- Alfresco server + its OOo extension [ Oracle done, Opal - opensource - done ]
- Alfresco server + its MSO extension
- Alfresco server in sharepoint mode + MSO native
- Alfresco server in sharepoint mode + Oracle OOo extension
- A test with native Sharepoint would be nice as well
- Need to look after if the sharepoint protocol spec is available or not [ done, yes ]

We suspect that a part of Alfresco is a more or less standalone sharepoint
server implementation, but need to search if such a client library is available
or not.

Related documentation:
http://wiki.services.openoffice.org/wiki/JavaEclipseTuto

=== 2011-02-20

1) The sharepoint spec seems to be available here:
http://msdn.microsoft.com/en-us/library/dd912094%28v=office.12%29.aspx (134
pages)

2) Alfresco + OOo extension

Alfresco has Community and Enterprise editions:
http://www.alfresco.com/products/networks/compare/

It seems only the community edition is provided as a Linux 32bit binary:
http://wiki.alfresco.com/wiki/Download_and_Install_Alfresco (437MB)

After installing Alfresco, I was able to login as admin, create a new folder,
upload a sample document. It comes with a bundled OOo 3.2, but it seems the
Alfresco connector extension is not installed there...

Found one here:
http://extensions.services.openoffice.org/project/alfrescoconnector though it
mentions as Freeware (not opensource).

I installed it following this howto:
http://wiki.alfresco.com/wiki/Setting_up_OpenOffice_for_Alfresco (the tricky
part is the URL)

Basic functionality works:

- search
- result can be viewed
- can be checked out
- edited
- checked in

== 3rd week

=== 2011-02-21

In ULX: setting up working env (account creation, installing KDE, git, etc.)

Downloaded & installed Alfresco + the Oracle Alfresco extension on the ULX
machine (vishudda) as well, works fine..

Found an other Alfresco OOo extension that is opensource:
http://extensions.services.openoffice.org/en/project/OPAL (alfresco_3.x-opal_3.1.4)

Source code at:
http://forge.alfresco.com/scm/?group_id=196
but svn checkout is not public, only source code for 3.0 as a source tarball.

Downloaded binary ends in some OOo Basic runtime error (in Fedora OOo 3.3), probably caused by this Java exception:

----
com.sun.star.uno.Exception: com.sun.star.configuration.ConfigurationProvider factory: unknown argument enablesync
        at com.sun.star.bridges.jni_uno.JNI_proxy.dispatch_call(Native Method)
        at com.sun.star.bridges.jni_uno.JNI_proxy.invoke(JNI_proxy.java:175)
        at $Proxy3.createInstanceWithArgumentsAndContext(Unknown Source)
        at fr.starxpert.opal.comp.utils.UnoUtils.getConfigAccess(UnoUtils.java:121)
        at fr.starxpert.opal.comp.ui.ConnectionDialog.updateListServer(ConnectionDialog.java:206)
        at fr.starxpert.opal.comp.ui.ConnectionDialog.execute(ConnectionDialog.java:236)
        at fr.starxpert.opal.comp.ui.AbstractDialog.run(AbstractDialog.java:94)
        at fr.starxpert.opal.comp.AuthenticationManagerImpl.execute(AuthenticationManagerImpl.java:130)
----

Tried with the bundled (in Alfresco) OOo 3.2, but there it fails at installation already:

----
Could not create Java implementation loader
----

Tried installing OOo 3.2, though graphical installer failed to some rpm
dependency problem. So tried manually:

----
mkdir ~/ooo32
rpm --nodeps --upgrade --ignoresize -vh --relocate /opt=/home/vmiklos/ooo32//opt --dbpath /home/vmiklos/ooo32/.RPM_OFFICE_DATABASE ~/git/diploma1/opal/ooo-3.2/OOO320_m18_native_packed-1_en-US.9502/RPMS/*rpm
----

And the connection dialog opens in OOo 3.2.1!

Connecting does not work, but a usable exception is logged in tomcat's log,
OPAL has some server-side part in Alfresco, the French documentation
how to install that:

- have to copy the .amp file to the alfresco amp/ directory
- run bin/apply_amps.sh, restart alfresco

and then it works! (Same basic functionality: open, save, close)

Still need to test:

- test OPAL with upstream OOo 3.3 (maybe OPAL just does not work with OOo 3.3
  from RPM due to a Fedora packaging issue?) -> done, it fails that way, too.
- build OPAL from source (waiting for mail from starxpert guys - authors of OPAL)

Previous not completed ones:

- Alfresco server + its MSO extension
- Alfresco server in sharepoint mode + MSO native
- Alfresco server in sharepoint mode + Oracle OOo extension
- A test with native Sharepoint would be nice as well

=== 2010-02-23

Managed to check out the source code of OPAL - it truns out by anonymous, they
meant 'there is open registration, and every registered user can check out the
code'. No reply from the Starxpert guys, though.

Mailed two extension developers I know to ask them about the OOo 3.2 vs 3.3
extension issue from 21th.

=== 2010-02-24

Tried compiling OPAL from source, using the already mentioned tutorial:

http://wiki.services.openoffice.org/wiki/JavaEclipseTuto

Asked on #libreoffice (irc.freenode.net) what version of Eclipse integration
should I try to install, Cedric (the main developer of OOEclipse) recommends
the 'dev' version, but its update site is broken at the moment, so he suggested
building my own update site.

Installed eclipse and its development package:

----
# yum install eclipse-platform eclipse-jdt eclipse-cdt
----

Cloned the ooeclipse repo:

----
git clone git://anongit.freedesktop.org/libreoffice/contrib/ooeclipse
cd ooeclipse/build
ANT_ARGS="-Dopenoffice.home=/home/vmiklos/ooo32/opt/openoffice.org3 -Declipse.home=/usr/lib64/eclipse" ant
----

Build went fine, I added the new site to Eclipse as

----
file:/home/vmiklos/git/ooeclipse/site/
----

but I got dependency errors in Eclipse 3.6 during installation:

----
Cannot complete the install because one or more required items could not be found.
  Software being installed: LibreOffice development plugin support for Java implementation 1.0.3 (org.openoffice.ide.eclipse.java.feature.group 1.0.3)
  Missing requirement: Ant UI 3.5.0.v20100427 (org.eclipse.ant.ui 3.5.0.v20100427) requires 'bundle org.eclipse.ant.launching [1.0.0,2.0.0)' but it could not be found
  Cannot satisfy dependency:
    From: Eclipse Java Development Tools 3.6.1.r361_v20100714-0800-7z8XFUSFLBmsgvVz0z-3vjz095IX (org.eclipse.jdt.feature.group 3.6.1.r361_v20100714-0800-7z8XFUSFLBmsgvVz0z-3vjz095IX)
    To: org.eclipse.ant.ui [3.5.0.v20100427]
  Cannot satisfy dependency:
    From: LibreOffice development plugin support for Java implementation 1.0.3 (org.openoffice.ide.eclipse.java.feature.group 1.0.3)
    To: org.eclipse.jdt.feature.group 0.0.0
----

So I tried installing under eclipse upstream 3.6 (not from yum), and that
worked (took a lot if time, but no errors).

Then I imported the 'OPAL_OOo_Alf3_trunk' project (which is supposed to be the
source for of the OOo extension) to Eclipse, but it won't build:

----
No SDK or OOo set: won't build	OPAL_OOo_Alf3_trunk		Unknown	Problem
Project 'OPAL_OOo_Alf3_trunk' is missing required Java project: 'SDK AlfrescoEmbedded'	OPAL_OOo_Alf3_trunk		Build path	Build Path Problem
The project cannot be built until build path errors are resolved	OPAL_OOo_Alf3_trunk		Unknown	Java Problem
----

So I searched what SDK is available that could be downloaded, and found
http://dl.alfresco.com/release/community/build-3370/alfresco-community-sdk-3.4.d.zip
(198MB)

The `lib/server` subdirectory of that tarball contains a project named 'SDK
AlfrescoEmbedded'. There were a few build errors after this, but that was easy
to fix (java source code level and such).

Now to install it and try if it works. The File -> Export -> UNO wizart just
does nothing when one would click on 'Finish'.

So first I create a helloworld project and see if that works, ie if the issue
is specific to OPAL or not.

Following the howto (linked above) I created a HelloWorld project, but the wizard ends with:

----
An internal error occurred during: "Uno Project creation job".
org/openoffice/plugin/core/utils/XMLWriter
----

Poked Cedric about the issue - in case he knows what can be the problem.

Another test: let's see if helloworld project works in case I use the OOo-3.3
(from system rpm) SDK. -> same :(

Got reply from Cedric: non-dev version is supposed to work with Eclipse 3.5 -
so I'm trying the helloworld there.

The tutorial went fine till project generation / build, but it's not possible
to export it. I reported that to Cedric, and for now I can work it around by
manually zipping the binaries (oxt is a zip file in fact).

As a result, finally my little modification renaming a menu item showed up in
OOo. This is only a config file, not a real code change, though.

When there is a code change, then Eclipse automatically builds the project, so
only the jar file has to be updated (manually.. that could be improved), and
the jar file has to be copied, like:

----
cat OPAL_OOo_Alf3_trunk.jar > /home/vmiklos/.openoffice.org/3/user/uno_packages/cache/uno_packages/xFd4dl_/alfresco_3.x-opal_3.1.4_trunk.oxt/OPAL_OOo_Alf3_trunk.jar
----

After restarting OOo, the change appears!

(A simple System.out.println() in case the connection dialog is closed with an
enter.)

Talked with Cedric, he can reproduce the project creation bug and said that the
oxt export has been rewritten since the stable release, so it does not worth
debugging the stable version's this part.

Summary:
- OOo 3.2, Eclipse 3.5, OOEclipse stable and OPAL from svn works more or less togother.
- the build part is not nice yet - manually creating the jar & oxt is a no-go in the long term
- OOEclipse developer responds, so it worths reporting issues to him
- code and wiki contents will be uploaded to svn repos at ULX next week

=== 2010-02-27

Today's target is to evaluate the sharepoint interface of Alfresco.

Word 2007 runs in a virtual machine on Windows and the host IP is 192.168.239.3.

Documentation:

http://wiki.alfresco.com/wiki/Alfresco_Labs_3#Microsoft_Office_SharePoint_Protocol_Support

The first problem is that Word requires the sharepoint server to be a trusted
site, but trusted sites must use https. OTOH tomcat does not listen on https by
default.

Relevant tomcat documentation:

http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html

I configured the keystore as described above.

`tomcat/conf/server.xml` contains a commented out example (search for
`port="8443"`) for listening on port 8443, accessing the site via https works
after removing the comments and restarting alfresco.

Later it turned out that the vti module (which implements the sharepoint
interface) listens on port 7070 and it's also possible to avoid https for
trusted sites (this is just a default requirement, but you can disable that).

Now in Word I tried: Office button -> Publish -> Create document workspace and
passsed `http://192.168.239.3:7070/alfresco` as the location for new workspace
(`SPP` as name, but that could be anything else - page 7 of the above mentioned
Getting_Started_with_SPP_Support_for_Labs_3_Stable.pdf), but that just resulted
in:

----
Action could not be completed. For more information, contact your site administrator, or try again later.
----

The sad fact is that no log file under `tomcat/logs` changed, so I need to dig
deeper to find some usable error message.

I set log4j.logger.org.alfresco.module.vti=debug in
`tomcat/webapps/alfresco/WEB-INF/classes/log4j.properties`, and then
alfresco.log contains:

----
19:39:02,352 DEBUG [org.alfresco.module.vti.handler.alfresco.v3.ShareUtils] Trying to create site with name: SPP. URL: http://s12:8080/alfresco/s/api/sites?alf_ticket=TICKET_ebc578da44d59e260e483105523dafec305e1421
19:39:02,506 DEBUG [org.alfresco.module.vti.handler.alfresco.v3.ShareUtils] Fail to create site with name: SPP. Message: The server s12 failed to respond
----

Which obviously won't work, as s12 resolves to 127.0.0.1, so the guest machine
tries to connect to itself...

Additionally, even if I configured it to port 8081, it tries to connect to the
default 8080, so finally I gave up and moved my (unrelated) proxy from 8080
elsewhere.

After that, saving to Alfresco from MSO works!

A few more notes:

- It seems there are two WAR files in tomcat, 'share' and 'alfresco'. The previous is a newer client, the later is the older one.

- When 'share' prints:

----
The remote server may be unavailable or your authentication details have not been recognized.
----

During login, that usually means some configuration error. In my case I had to
grep for 8080 in the alfresco directory and once I changed 8081 to 8080 in
every config file, the problem want away...

OK, so once initial document upload feature works, let's see what else can we do.

- Opening an existing document:

Office button -> Open, `http://192.168.239.3:7070/alfresco` lists existing
spaces and then opening for example `SPP/documentLibrary/test.doc` is possible.
The usual Office -> Save works properly.

- Office -> Server -> Check out: making a private copy and lock the server version

- Check in: unlock + commit message (and optionally avoid unlocking)

- Update

- Add members to the space (with email invitation, showing if they are online
  or not; and with roles, like Site Manager or normal user)

- Task list - attached to the space

- file / folder list - though this seems to be redundant with Office -> open

- Link list

- View version history (Office -> Save has no comments, check in can have)

And I probably missed something. Plenty of features to implement. :)

A totally different topic is: can we reuse some existing sharepoint client code
to avoid reinventing the wheel? Gabor's original idea was to use sharepoint
code from alfresco, but it turns out that contains sharepoint server code only,
so that does not really help here.

Related software I found:

- http://extensions.services.openoffice.org/en/project/sharepoint_connector
  This is Oracle's sharepoint extension. It's commercial, a trial version can
  be downloaded.
- http://www.pdfburst.com/license.html DocumentBurster - this can upload to SharePoint
- http://code.google.com/p/google-enterprise-connector-sharepoint/source/browse/#svn%2Ftrunk%2Fprojects%2Fsharepoint another client code - to index sharepoint documents using Google
- http://code.google.com/p/bevy/source/browse/#svn%2Ftrunk%2FJavaEE%2FPortlets%2FWSSPortlet similar, but looks quite minimalistic and dead
- https://github.com/fabsor/sharepoint drupal integration - this sounds quite nice, even if it's in PHP, it's maintained and has some documentation for the "it's in the spec but in some hard to parse form" cases
- https://github.com/rgeyer/sp-wsapi-consumer a generic php sharepoint libarary using nusoap, looks incomplete

From the above list I think the Oracle one may worth looking for a user
interface idea and probably the drupal module can give ideas.

A note: I just noticed that for example all the WSDL files (which can serve as
a good base for the client code) are missing from alfresco - so even if it
works with MSO, the real sharepoint server will be probably easier to develop
against.

== 4th week

=== 2011-02-28

In ULX. So far I tracked my documentation in a private repo, now it's available
at
http://build.ulx.hu/svn/vmiki-diploma/trunk/doc/

I will still upload its contents to the wiki weekly.

Ideas for today:

- Try out Oracle's sharepoint ooo extension
- No email reply from starxpert - try to find some forum if possible.
- Install a real sharepoint server
- Play around with its wsdl interfaces in Java / start understanding the
  interfaces based on the spec or drupal code

Oracle's sharepoint extension:

It's sadly only available on Win32. (No Linux32 or Linux64 version.)

After downloading a 150M zip file, the real extension is
oracle-sharepoint-connector.oxt, but it requires changes on the sharepoint
server side... For now, I gave up here.

Starxpert forum:

The class names on OPAL are under starxpert.fr, though their support forum is
under http://forums.alfresco.com/en/ - it seems.

It does not sounds too promising though, the only thread regarding opal is this one:
http://forums.alfresco.com/en/viewtopic.php?t=23507 - and nobody replied.

There is also an IRC support channel ##alfresco on irc.freenode.net - I asked
there as well, but no reply so far.

Given that Ivan is out of office today, I did not start installing a virtual
machine / sharepoint but continued to debug the opal plugin to find out how to
build a usable version from source.

One trick I found is that on startup Eclipse complains about missing OOo SDK. A
workaround I did previously was to delete those errors, and then I could invoke
the exporter. However, a better solution for this is to open the project
properties and click OK (without any changes) this way the exporter does not
hang...

This way I tested both config (.xcu) and Java changes - both are working with
the following quite basic workflow:

- do the change in Eclipse
- project properties - uno properties - OK (without changes)
- file -> export -> openoffice package -> finish. deploy? no (it would deploy to system-OOo, which is at 3.3, not our 3.2)
- in OOo: uninstall the extension, install it, restart

Even if this is pretty slow, something that works with Eclipse 3.5 + OOEclipse
stable (1.1.2 + Java part 1.0.2) + OOo 3.2, and now no manual jar/oxt creation
is needed, at least these parts are done by Eclipse.

It turns out that OOEclipse calls the `unopkg` command to deploy the extension,
so if I play around with PATH to calls the 3.2 version of unopkg, then the
deploy part works automatically. This means that the extension will be
removed/installed automatically and only a single restart is needed.

I gave Eclipse 3.6 & OOEclipse dev a try again, but the export wizard has been
rewritten there and I can't seem to deploy the extension with the new wizard,
so I ignore that for now.

I also created an opal-client directory in ULX trunk, which is an import of
upstream OPAL svn + fixes to make it work with OOo 3.2.

At the end, I continued reading the spec, but of course it's a bit pointless to
do so without being able to try it - hopefully we can do the sharepoint
installation soon when Ivan will be back.

Summary of what I read so far:

- the client sends xml (soap) over http requests, the response is json over http
- the request is a list of actions to be performed, and the result of these actions is returned by the server
- authentication is not hardwired, the simplest one is using http basic
- most of the text should be used later as a reference, ie dozen of times it lists a zillion of different integer types (specified by xml schema, etc)

Next to read: chapter 4 (protocol examples).

=== 2011-03-04

Got reply from the starxpert guys, nothing helpful, but at least now I know
they got my mail. Asked them if they have any plan to fix OPAL wrt OOo 3.3
(since it works with 3.2 only here).

We decided the Hungarian title of the thesis: "Nyílt forráskódú irodai
programkomponensek vállalati környezetbe való integrációjának vizsgálata és
implementációja".

It could be something like: "Analysis and implementation of integrating
open-source office program-components into enterprise environment."

No SVN access at home (which is a pain), but Ivan is already on it.

=== 2011-03-05

At home, fired up MSO and Alfresco + Wireshark to sniff network traffic. The
initial authentication (`tcp.stream eq 19` in `20110305.dump`) is like this:

----
GET /_vti_inf.html HTTP/1.1
Date: Sat, 05 Mar 2011 22:53:40 GMT
MIME-Version: 1.0
Accept: */*
User-Agent: Mozilla/4.0 (compatible; MS FrontPage 12.0)
Host: 192.168.239.3:7070
Accept: auth/sicily
Content-Length: 0
Connection: Keep-Alive
Cache-Control: no-cache

HTTP/1.1 401 Unauthorized
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Set-Cookie: JSESSIONID=1r9brw0xkuqgx;Path=/
WWW-Authenticate: BASIC realm="Alfresco Server"
Content-Length: 0
Server: Jetty(6.1.14)

GET /_vti_inf.html HTTP/1.1
Date: Sat, 05 Mar 2011 22:53:40 GMT
MIME-Version: 1.0
Accept: */*
User-Agent: Mozilla/4.0 (compatible; MS FrontPage 12.0)
Host: 192.168.239.3:7070
Accept: auth/sicily
Content-Length: 0
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=1r9brw0xkuqgx
Authorization: Basic YWRtaW46YWxmcmVzY28=

HTTP/1.1 200 OK
Public-Extension: http://schemas.microsoft.com/repl-2
MicrosoftSharePointTeamServices: 14.00.0.000
Cache-Control: private
Content-Type: text/html
Content-Length: 246
Server: Jetty(6.1.14)

<!-- FrontPage Configuration Information
 FPVersion="14.00.0.000"
FPShtmlScriptUrl="_vti_bin/shtml.dll/_vti_rpc"
FPAuthorScriptUrl="_vti_bin/_vti_aut/author.dll"
FPAdminScriptUrl="_vti_bin/_vti_adm/admin.dll"
TPScriptUrl="_vti_bin/owssvr.dll"
-->

POST /_vti_bin/shtml.dll/_vti_rpc HTTP/1.1
Date: Sat, 05 Mar 2011 22:53:44 GMT
MIME-Version: 1.0
User-Agent: MSFrontPage/12.0
Host: 192.168.239.3:7070
Accept: auth/sicily
Content-Length: 42
Content-Type: application/x-www-form-urlencoded
X-Vermeer-Content-Type: application/x-www-form-urlencoded
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=1r9brw0xkuqgx
Authorization: Basic YWRtaW46YWxmcmVzY28=

method=server+version%3a12%2e0%2e0%2e6211

HTTP/1.1 200 OK
MicrosoftSharePointTeamServices: 14.00.0.000
Cache-Control: no-cache
Content-Type: application/x-vermeer-rpc
Connection: close
Server: Jetty(6.1.14)

<html><head><title>vermeer RPC packet</title></head>
<body>
<p>method=server version:14.0.0.4730
<p>server version=
<ul>
<li>major ver=14
<li>minor ver=0
<li>phase ver=0
<li>ver incr=4730
</ul>
<p>source control=1
</body>
</html>
----

So all starts with the client trying to access `_vti_inf.html` on the server.
Not something in the spec. (I wonder: do I read the right spec?)

Then the authentication is HTTP Basic, that's simple. Then it posts something
to `/_vti_bin/shtml.dll/_vti_rpc`, no idea what is that, looks like RPCish, but
not XML-based.

The next flow (`tcp.stream eq 20`) is this:

----
POST /_vti_bin/shtml.dll/_vti_rpc HTTP/1.1
Date: Sat, 05 Mar 2011 22:53:44 GMT
MIME-Version: 1.0
User-Agent: MSFrontPage/12.0
Host: 192.168.239.3:7070
Accept: auth/sicily
Content-Length: 66
Content-Type: application/x-www-form-urlencoded
X-Vermeer-Content-Type: application/x-www-form-urlencoded
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=1r9brw0xkuqgx
Authorization: Basic YWRtaW46YWxmcmVzY28=

method=url+to+web+url%3a12%2e0%2e0%2e6211&url=%2falfresco&flags=0

HTTP/1.1 200 OK
MicrosoftSharePointTeamServices: 14.00.0.000
Cache-Control: no-cache
Content-Type: application/x-vermeer-rpc
Connection: close
Server: Jetty(6.1.14)

<html><head><title>vermeer RPC packet</title></head>
<body>
<p>method=url to web url:14.0.0.4730
<p>webUrl=/alfresco
<p>fileUrl=
</body>
</html>
----

I don't know yet where that `/alfresco` comes from, I did a logout before I
started capturing in the hope of that will empty any cache, and obviously MSO
won't speak about alfresco itself.

Then flow #21 is:

----
POST /alfresco/_vti_bin/_vti_aut/author.dll HTTP/1.1
Date: Sat, 05 Mar 2011 22:53:44 GMT
MIME-Version: 1.0
User-Agent: MSFrontPage/12.0
Host: 192.168.239.3:7070
Accept: auth/sicily
Content-Length: 67
Content-Type: application/x-www-form-urlencoded
X-Vermeer-Content-Type: application/x-www-form-urlencoded
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=1r9brw0xkuqgx
Authorization: Basic YWRtaW46YWxmcmVzY28=

method=open+service%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco
----

The answer omitted, it's the method response in this weird syntax, the point is
that here the client knows alfresco already and it calls this `open service`
method.

Flow #22 is where the actual root directory listing is sent:

----
GET /alfresco/_vti_bin/owssvr.dll?location=&dialogview=FileOpen&FileDialogFilterValue=*.*; HTTP/1.1
Accept: */*
Accept-Language: hu
UA-CPU: x86
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727; InfoPath.2; AskTbFXTV5/5.9.1.14019)
Host: 192.168.239.3:7070
Connection: Keep-Alive
Cookie: JSESSIONID=1r9brw0xkuqgx
Authorization: Basic YWRtaW46YWxmcmVzY28=
----

And the response is a HTML page with css, javascript and every other kind of
fancy stuff. And that's the last flow in the dump, which was recorded during a:

- Office -> Open
- Enter URL
- Give user / password

Now the next step would be to figure out:

- what is that weird RPC syntax
- from where does MSO get the alfresco string
- if it's cached, need to look after how can I empty such a cache

=== 2011-03-06

OK, I missed the fact that I passed the URL
`http://192.168.239.3:7070/alfresco/` to MSO, so that's why it knew the
alfresco path..

The RPC syntax is documented here: http://msdn.microsoft.com/en-us/library/ms442469.aspx
The list of used methods are here: http://msdn.microsoft.com/en-us/library/ms454298.aspx

The sad thing is that it seems the folder list has to be parsed manually or we
need Javascript... (the previous sounds saner to me).

Given that The above documentation is more a reference than a guide describing
a process of performing tasks, here is my understanding so far about loading
the folder list - the following steps are required:

1. Authorization - /_vti_inf.html
2. Get server version - /_vti_bin/shtml.dll/_vti_rpc
3. Translate /alfresco URL to web URL - /_vti_bin/shtml.dll/_vti_rpc
4. Open service - /alfresco/_vti_bin/_vti_aut/author.dll
5. Get info for File Open - /alfresco/_vti_bin/owssvr.dll

Now, continuing yesterday's capture, I created a new dump, containing the download of SPP/documentLibrary/local.doc:

- flow #16 is File Open, it also contains:

----
GET /alfresco/SPP/_vti_bin/owssvr.dll?location=&dialogview=FileOpen&FileDialogFilterValue=*.*
GET /alfresco/SPP/_vti_bin/owssvr.dll?location=documentLibrary&dialogview=FileOpen&FileDialogFilterValue=*.*
----

so that the filename is known.

- flow #20 calls the checkout method:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll

method=checkout+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document%5fname=documentLibrary%2flocal%2edoc&force=0&timeout=10
----

- flow #21:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll

method=getDocsMetaInfo%3a12%2e0%2e0%2e6211&url%5flist=%5bdocumentLibrary%2flocal%2edoc%5d&listHiddenDocs=false&listLinkInfo=false
----

- flow #22:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll

method=uncheckout+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document%5fname=documentLibrary%2flocal%2edoc&force=false&rlsshortterm=true
----

- flow #23:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll
method=get+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document%5fname=documentLibrary%2flocal%2edoc&old%5ftheme%5fhtml=false&force=false&get%5foption=chkoutExclusive&doc%5fversion=&timeout=10
----

The reply to this request is a html one, but after </html>, the binary doc arrives.

- flow #24:

----
HEAD /alfresco/SPP/documentLibrary/local.doc HTTP/1.1
----

just to make sure?

- flow #25:

----
POST /_vti_bin/webs.asmx HTTP/1.1
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/WebUrlFromPageUrl
----

This is a SOAP message, it just translates http://192.168.239.3:7070/alfresco/SPP/documentLibrary/local.doc to http://192.168.239.3:7070/alfresco/SPP

- flow #26:

----
POST /alfresco/SPP/_vti_bin/workflow.asmx HTTP/1.1
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/workflow/GetWorkflowDataForItem
----

empty reply.

Releasing a document (20110306-release.dump):

- flow #2:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll
method=uncheckout+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document%5fname=documentLibrary%2flocal%2edoc&force=false&rlsshortterm=true
----

The above should be enough to write a simple client that can list directories,
checkout a document, then uncheckout it.

As a start, I wrote a small prototype that can just download a document from
the server (no directory listing or checkout yet), called `proto.py`.

== 5th week

=== 2011-03-07

In ULX. No Windows VM here, so I use my machine where I have MSO installed
already.

Had a small meeting with Gabor and Ivan:

- SVN access and real sharepoint server will be sorted out
- one-page description of my thesis will be handled by Ivan
- this week I'll work on a simple Python commandline prototype
- after that, I'll begin modifying the OPAL extension to use the sharepoint protocol

Completed the prototype up to being able to download any file from the server
(without checkout / uncheckout RPC calls), including directory listing.

Created a separate document (opal-howto.txt) on how to set up OPAL, as
requested by Ivan. Wasted a lot of time on it, for some reason I got a strange
exception:

----
org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'LuceneFullTextSearchIndexer' defined in class path resource [alfresco/core-services-context.xml]: Cannot resolve reference to bean 'luceneFullTextSearchIndexer' while setting bean property 'target'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'luceneFullTextSearchIndexer' defined in class path resource [alfresco/core-services-context.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.CannotLoadBeanClassException: Error loading class [fr.starxpert.opal.document.DownloadDocument] for bean with name 'webscript.fr.starxpert.opal.document.download.get' defined in file [/home/vmiklos/documents/bme/diploma1/alfresco/alfresco-3.4.d/tomcat/webapps/alfresco/WEB-INF/classes/alfresco/module/opal/module-context.xml]: problem with class file or dependent class; nested exception is java.lang.NoClassDefFoundError: org/alfresco/web/scripts/AbstractWebScript
----

on startup, at the end I worked it around by copying over the tomcat directory
from the ULX machine where I already had OPAL set up.

Next time I want to continue with proper open/close (checkout / uncheckout) and
then Space creation, file save.

=== 2011-03-11

I'm collecting the features OPAL provides, that can server as a base on what to
sniff with Wireshark regarding the sharepoint protocol:

- Connection (login) [done]
- Open [done]
- Save
- Save as
- Properties (created/creator, modified/modifier, title, name) - get; also set for title
- Versions (version, name, creator, date)

Save in sharepoint (20110311-save.dump):

- flow #4:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll
method=getDocsMetaInfo%3a12%2e0%2e0%2e6211&url%5flist=%5bdocumentLibrary%2flocal%2edoc%5d&listHiddenDocs=false&listLinkInfo=false
----

part of the result is:

----
<li>vti_timelastwritten
<li>TR|11 Mar 2011 16:39:35 +0000
----

- flow #6:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll HTTP/1.1
method=put+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document=%5bdocument%5fname%3ddocumentLibrary%2flocal%2edoc%3bmeta%5finfo%3d%5bvti%5ftimelastmodified%3bTW%7c11+Mar+2011+16%3a39%3a35+%2d0000%5d%5d&put%5foption=edit&comment=&keep%5fchecked%5fout=false
<binary doc here>
----

Save as - saved `SPP/local.doc` as `SPP/local2.doc` (20110311-saveas.dump):

- flow #14:

----
GET /alfresco/SPP/_vti_bin/owssvr.dll?location=documentLibrary&dialogview=FileSave&FileDialogFilterValue=*.doc; HTTP/1.1
----

- flow #16:

----
POST /_vti_bin/shtml.dll/_vti_rpc
method=url+to+web+url%3a12%2e0%2e0%2e6211&url=%2falfresco%2fSPP%2fdocumentLibrary%2flocal3%2edoc&flags=0
----

- flow #17:

----
POST /_vti_bin/webs.asmx HTTP/1.1
<lots of soap bloat here>
----

- flow #18:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll HTTP/1.1
method=getDocsMetaInfo%3a12%2e0%2e0%2e6211&url%5flist=%5bdocumentLibrary%2flocal3%2edoc%5d&listHiddenDocs=false&listLinkInfo=false
----

The response to this is a list of failed URLs - ie. local2.doc does not exist yet.

- flow #20:

----
OPTIONS / HTTP/1.1

HTTP/1.1 200 OK
Allow: GET, POST, OPTIONS, HEAD, MKCOL, PUT, PROPFIND, PROPPATCH, DELETE, MOVE, COPY, GETLIB, LOCK, UNLOCK

OPTIONS /alfresco/SPP/documentLibrary/local3.doc HTTP/1.1

HTTP/1.1 200 OK
Allow: GET, POST, OPTIONS, HEAD, MKCOL, PUT, PROPFIND, PROPPATCH, DELETE, MOVE, COPY, GETLIB, LOCK, UNLOCK
DocumentManagementServer: Properties Schema;Source Control;Version History;

POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll HTTP/1.1
method=getDocsMetaInfo%3a12%2e0%2e0%2e6211&url%5flist=%5bhttp%3a%2f%2f192%2e168%2e152%2e1%3a7070%2falfresco%2fSPP%2fdocumentLibrary%5d&listHiddenDocs=false&listLinkInfo=false
...
----

- flow #25:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll HTTP/1.1
method=put+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document=%5bdocument%5fname%3ddocumentLibrary%2flocal3%2edoc%3bmeta%5finfo%3d%5b%5d%5d&put%5foption=edit&comment=&keep%5fchecked%5fout=false
<contents of local3.doc comes here>
----

In short, it seems save as is the same as save; `put document` handles both.

Version history (20110311-versions.dump):

- flow #13:

----
POST /alfresco/SPP/_vti_bin/versions.asmx HTTP/1.1
<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<GetVersions xmlns="http://schemas.microsoft.com/sharepoint/soap/">
<fileName>documentLibrary/local.doc</fileName>
</GetVersions>
</soap:Body>
</soap:Envelope>

HTTP/1.1 200 OK
MicrosoftSharePointTeamServices: 14.00.0.000
Cache-Control: no-cache
Content-Type: application/x-vermeer-rpc
Connection: close
Server: Jetty(6.1.14)

<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
  <s:Body>
    <GetVersionsResponse xmlns="http://schemas.microsoft.com/sharepoint/soap/">
      <GetVersionsResult>
        <results>
          <list id=""/>
          <versioning enabled="1"/>
          <settings url="http://192.168.152.1:7070/alfresco/SPP/documentDetails.vti?doc=workspace://SpacesStore/4a40175f-a970-4761-8140-eeaffa3c315d"/>
          <result version="@2.1" url="http://192.168.152.1:7070/alfresco/SPP/documentLibrary/local.doc" created="3/11/2011 5:40 PM" createdBy="admin" size="22016" comments=""/>
          <result version="1.0" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/8376fb02-de19-457f-8911-5d9fa5a54f36/local.doc" created="2/27/2011 8:07 PM" createdBy="admin" size="22016" comments=""/>
          <result version="1.1" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/32e2c176-94b3-40b0-9b66-052b72a1290b/local.doc" created="2/27/2011 8:08 PM" createdBy="admin" size="26112" comments=""/>
          <result version="1.2" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/10289069-1d73-44ca-9d5d-412b3490c06c/local.doc" created="2/27/2011 9:00 PM" createdBy="admin" size="22016" comments=""/>
          <result version="1.3" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/34c60cb2-1115-48d9-9ed4-e832637cd075/local.doc" created="2/27/2011 9:02 PM" createdBy="admin" size="22016" comments=""/>
          <result version="1.4" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/64adf5da-a95e-41da-ae24-02704eba6dd5/local.doc" created="2/27/2011 9:02 PM" createdBy="admin" size="22016" comments=""/>
          <result version="2.0" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/b766c852-b8ae-4afa-8ae3-faeaed2df7b2/local.doc" created="2/27/2011 9:06 PM" createdBy="admin" size="22016" comments="5th line"/>
        </results>
      </GetVersionsResult>
    </GetVersionsResponse>
  </s:Body>
</s:Envelope>
----

(XML tidy by me.)

So this one is SOAP - but at least a single request. Also note that simple save
is just 1.2 -> 1.2, but when a comment is entered there is a major bump (1.4 ->
2.0). I need to try out if this is just about the comment parameter (see above)
on save, or something more complex is needed as well.

For now - that's it. I'll continue tomorrow with implementing save
(with/without comments) and version listing in the prototype.

=== 2011-03-12

I started implementing 'save' in the prototype, though it took some time - at
one place in the http request header I missed up the CRLF (`\n` vs `\r\n`) and
it took hours to debug it.

So what the prototype does at the moment is calling the 'put document' method
for an existing file, and I get 'A file already exsits.' as a response. I need
to look at the dump again, I guess the problem is that right now I just try to
do a 'put document' while it's required to check out a document before checking
it in.

The sequence without ignoring any detail (20110312-opensave.dump):

- open service (flow #4)
- getDocsMetaInfo (flow #6)
- HEAD /alfresco/SPP/documentLibrary/local.doc (flow #7)
- checkout+document (#8)
- getDocsMetaInfo (#10)
- uncheckout+document (#11)
- get+document (#12)
- HEAD /alfresco/SPP/documentLibrary/local.doc (#13)
- getDocsMetaInfo (#15)
- put+document (#16)
- HEAD /alfresco/SPP/documentLibrary/local.doc (#17)

One more pitfall: if there is no `\n` at the end of method= lines, alfresco
gives a `java.lang.OutOfMemoryError` after a timeout.

Given that I had no idea what did I do wrong, I looked up the source of the
Alfresco VTI module (which implements the sharepoint support). It's here:

http://svn.alfresco.com/repos/alfresco-open-mirror/alfresco/HEAD/root/modules/sharepoint/amp/source/java/org/alfresco/module/vti

From this it's easy, AlfrescoMethodHandler::putDocument() contains the code,
and the modification date should not be the current time, but the one
previously returned by getDocsMetaInfo().

And that's it, uploading a file (overwriting an existing one on the server)
works!

Then I implemented 'save as' for non-existing files as well, that's just about
generating the timestamp of the file using the system clock; and normal 'save'
as well.

That's all for today (this time I spent the whole day on this), tomorrow I want
to have a look at how to attach comment to a save + how to list versions.

=== 2011-03-13

Commented versions are created by a checkin+checkout pair, not using save. In
alfresco terminology, we're creating a new (major) version, in this case.

The tasks in detail:

- check out
- discard check out
- check in

In the first session I just did a check out + check in with comment (20110313-savecomment.dump):

- flow #10:

----
POST /alfresco/SPP/_vti_bin/lists.asmx HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/CheckOutFile
X-Office-Version: 12.0.6213
User-Agent: Microsoft Office/12.0 (Windows NT 5.1; Microsoft Office Word 12.0.6213; Pro)
Host: 192.168.152.1:7070
Content-Length: 413
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=mpwdofjtdigl
Authorization: Basic YWRtaW46YWxmcmVzY28=

<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<CheckOutFile xmlns="http://schemas.microsoft.com/sharepoint/soap/">
<pageUrl>http://192.168.152.1:7070/alfresco/SPP/documentLibrary/local.doc</pageUrl><checkoutToLocal>true</checkoutToLocal><lastmodified>13 Mar 2011 19:34:17 +0000</lastmodified></CheckOutFile>
</soap:Body>
</soap:Envelope>

HTTP/1.1 200 OK
MicrosoftSharePointTeamServices: 14.00.0.000
Cache-Control: no-cache
Content-Type: text/xml
Connection: close
Server: Jetty(6.1.14)

<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><CheckOutFileResponse xmlns="http://schemas.microsoft.com/sharepoint/soap/"><CheckOutFileResult>true</CheckOutFileResult></CheckOutFileResponse></s:Body></s:Envelope>
----

- flow #26:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll HTTP/1.1
method=put+document%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&document=%5bdocument%5fname%3ddocumentLibrary%2flocal%2edoc%3bmeta%5finfo%3d%5bvti%5ftimelastmodified%3bTW%7c13+Mar+2011+19%3a54%3a11+%2d0000%5d%5d&put%5foption=edit&comment=&keep%5fchecked%5fout=false
----

- flow #28:

----
POST /alfresco/SPP/_vti_bin/lists.asmx HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/CheckInFile
X-Office-Version: 12.0.6213
User-Agent: Microsoft Office/12.0 (Windows NT 5.1; Microsoft Office Word 12.0.6213; Pro)
Host: 192.168.152.1:7070
Content-Length: 367
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=mpwdofjtdigl
Authorization: Basic YWRtaW46YWxmcmVzY28=

<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<CheckInFile xmlns="http://schemas.microsoft.com/sharepoint/soap/">
<pageUrl>http://192.168.152.1:7070/alfresco/SPP/documentLibrary/local.doc</pageUrl><comment>alma</comment><CheckinType>0</CheckinType></CheckInFile>
</soap:Body>
</soap:Envelope>

HTTP/1.1 200 OK
MicrosoftSharePointTeamServices: 14.00.0.000
Cache-Control: no-cache
Content-Type: text/xml
Connection: close
Server: Jetty(6.1.14)

<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><CheckInFileResponse xmlns="http://schemas.microsoft.com/sharepoint/soap/"><CheckInFileResult>true</CheckInFileResult></CheckInFileResponse></s:Body></s:Envelope>
----

Now the problem is that when I try to send the first message, I get:

----
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
  <s:Body>
    <s:Fault>
      <faultcode>s:Server</faultcode>
      <faultstring>class java.lang.NullPointerException</faultstring>
      <detail>
        <errorstring xmlns="http://schemas.microsoft.com/sharepoint/soap/">Unknown error</errorstring>
      </detail>
    </s:Fault>
  </s:Body>
</s:Envelope>
----

Now I'm digging in the config files on what debug logging to enable, as by
default the stackstrace is not logged.

So far what I've found:

- tomcat/webapps/alfresco/WEB-INF/classes/log4j.properties controls the debug level of modules
- http://forums.alfresco.com/en/viewtopic.php?t=8834 sounds helpful, but does not change the log output here

After a bit more trying, it turned out that the problem is: the IP address of
the server from the VM and in the host machine is of course different (from the
VM: 192.168.152.1, from host: 127.0.0.1) and I should properly update the IP
address in the message + update the 'Content-Length:' header.

(Sigh, to figure this out, it took about 3 hours...)

The new output is like this:

----
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
  <s:Body>
    <CheckOutFileResponse xmlns="http://schemas.microsoft.com/sharepoint/soap/">
      <CheckOutFileResult>false</CheckOutFileResult>
    </CheckOutFileResponse>
  </s:Body>
</s:Envelope>
----

Now setting 'log4j.logger.org.alfresco.module.vti=debug' in log4j.properties, I
finally get a usable error:

----
00:39:27,708 DEBUG [org.alfresco.module.vti.handler.alfresco.v3.AlfrescoCheckOutCheckInServiceHandler] Can't perform 'check out' operation for file '/SPP/documentLibrary/local.doc'
org.alfresco.service.cmr.coci.CheckOutCheckInServiceException: 02140000 This node is already checked out.
----

and yes, I forgot to check in the test doc in the VM...

To sum up, here are two soap messages I can send to the server to check out / check it (with message) a file:

----
POST /alfresco/SPP/_vti_bin/lists.asmx HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/CheckOutFile
X-Office-Version: 12.0.6213
User-Agent: Microsoft Office/12.0 (Windows NT 5.1; Microsoft Office Word 12.0.6213; Pro)
Host: 127.0.0.1:7070
Content-Length: 409
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=mpwdofjtdigl
Authorization: Basic YWRtaW46YWxmcmVzY28=

<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<CheckOutFile xmlns="http://schemas.microsoft.com/sharepoint/soap/">
<pageUrl>http://127.0.0.1:7070/alfresco/SPP/documentLibrary/local.doc</pageUrl><checkoutToLocal>true</checkoutToLocal><lastmodified>13 Mar 2011 22:21:23 +0000</lastmodified></CheckOutFile>
</soap:Body>
</soap:Envelope>
----

and

----
POST /alfresco/SPP/_vti_bin/lists.asmx HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/CheckInFile
X-Office-Version: 12.0.6213
User-Agent: Microsoft Office/12.0 (Windows NT 5.1; Microsoft Office Word 12.0.6213; Pro)
Host: 127.0.0.1:7070
Content-Length: 368
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=mpwdofjtdigl
Authorization: Basic YWRtaW46YWxmcmVzY28=

<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<CheckInFile xmlns="http://schemas.microsoft.com/sharepoint/soap/">
<pageUrl>http://127.0.0.1:7070/alfresco/SPP/documentLibrary/local.doc</pageUrl><comment>alma0048</comment><CheckinType>0</CheckinType></CheckInFile>
</soap:Body>
</soap:Envelope>
----

To sum up, now it should be easy to implement check in / check out in the
prototype, but I'm not doing it right now as it gets really late.

== 6th week

=== 2011-03-16

The title of the thesis is now final:

----
The analysis and integration of open-source office productivity software in an enterprise environment
----

Here is a thread from the LibreOffice user mailing list, where someone is
interested in the extension I'm about to create:

http://nabble.documentfoundation.org/Sharepoint-td2676422.html

Discussed the one-page diploma description with Akos, sent mail to ask a
virtual machine at MIT.

=== 2011-03-17

Got reply from MIT: I'll get the virtual machine early next week (they have air
conditioning problems right now).

Implemented CheckOutFile / CheckInFile in the proto.

=== 2011-03-18

Today's target is to implement listing of versions for opened files.

The user interface in Word has the following columns:

- No. (read: version)
- Modified (date)
- Modified By
- Size
- Comments

`20110311-versions.dump` already contains a request-reply pair, a few facts I
noticed in the meantime:

- the list is not sorted
- the actual version is prefixed with a @

The rest is pretty much just a dump of what is in the XML reply.

As a result I implemented GetVersions in the proto, even with natural sorting
of versions (after all, that was only two lines of code).

=== 2011-03-19

In ULX. The sharepoint server is not yet ready, so I continue with adding a few
more features to the proto.

Word has the ability to open, compare, restore and delete older versions of a
document. Compare is probably a more complex operation, but the rest 3 should
not be too hard to implement.

Open:

- a special url is returned by GetVersions for older versions of a document, like

----
http://127.0.0.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/b2108ee1-0fe9-4b5e-a88d-80fe9e45c1b8/aaa-test.txt
----

- a simple HTTP GET can reach this, once versionStore:// is replaced by versionStore:/ (why is that needed?)

I implemented this in the prototype as an 'open-older' subcommand. Luckily I
could reuse (ie. not copy&paste) most of the version lister and (last version)
opener code.

Restore:

From the Word UI, it works the following way: let's say versions 1.0..1.4 are
available, so 1.4 is the latest one. The user selects to 'restore' the 1.3
version, then a new (major) 2.0 version will be created with the contents of
the 1.3 one. Let's see how does this look like from Wireshark (20110319-restore.dump):

- flow #21:

----
POST /alfresco/SPP/_vti_bin/versions.asmx HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/RestoreVersion
X-Office-Version: 12.0.6213
User-Agent: Microsoft Office/12.0 (Windows NT 5.1; Microsoft Office Word 12.0.6213; Pro)
Host: 192.168.152.1:7070
Content-Length: 322
Connection: Keep-Alive
Cache-Control: no-cache
Cookie: JSESSIONID=otwdh3ghxtf1
Authorization: Basic YWRtaW46YWxmcmVzY28=

<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<RestoreVersion xmlns="http://schemas.microsoft.com/sharepoint/soap/">
<fileName>documentLibrary/aaa-test.txt</fileName>
<fileVersion>1.0</fileVersion>
</RestoreVersion>
</soap:Body>
</soap:Envelope>
----

and the reply is:

----
<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
  <s:Body>
    <RestoreVersionResponse xmlns="http://schemas.microsoft.com/sharepoint/soap/">
      <RestoreVersionResult>
        <results>
          <list id=""/>
          <versioning enabled="1"/>
          <settings url="http://192.168.152.1:7070/alfresco/SPP/documentDetails.vti?doc=/SPP/documentLibrary/aaa-test.txt"/>
          <result version="@5.0" url="http://192.168.152.1:7070/alfresco/SPP/documentLibrary/aaa-test.txt" created="3/19/2011 3:46 PM" createdBy="admin" size="11" comments=""/>
          <result version="1.0" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/51f70bd4-e582-4c22-a5aa-20fa1130bff5/aaa-test.txt" created="3/19/2011 2:50 PM" createdBy="admin" size="9" comments=""/>
          <result version="1.1" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/5cedc688-1a59-42e1-acc0-17d82e33ac4d/aaa-test.txt" created="3/19/2011 2:59 PM" createdBy="admin" size="11" comments=""/>
          <result version="1.2" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/faf6ada4-9231-4428-88b0-36cf264b9ae3/aaa-test.txt" created="3/19/2011 2:59 PM" createdBy="admin" size="11" comments=""/>
          <result version="1.3" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/b2108ee1-0fe9-4b5e-a88d-80fe9e45c1b8/aaa-test.txt" created="3/19/2011 3:13 PM" createdBy="admin" size="48" comments=""/>
          <result version="1.4" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/e1064b6d-4ce1-46a2-a17d-c4b2420994e3/aaa-test.txt" created="3/19/2011 3:13 PM" createdBy="admin" size="58" comments=""/>
          <result version="2.0" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/87a58c35-b0af-45e1-b65c-0a358d2c3307/aaa-test.txt" created="3/19/2011 3:36 PM" createdBy="admin" size="58" comments=""/>
          <result version="2.1" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/db971a09-d718-4bf0-b9f2-c42478e830d5/aaa-test.txt" created="3/19/2011 3:37 PM" createdBy="admin" size="48" comments=""/>
          <result version="2.2" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/b7efdf0a-a87b-444a-852f-3e002920e4c0/aaa-test.txt" created="3/19/2011 3:37 PM" createdBy="admin" size="48" comments=""/>
          <result version="3.0" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/3b6421a3-1faf-4777-9e9a-f5020eb01852/aaa-test.txt" created="3/19/2011 3:37 PM" createdBy="admin" size="48" comments=""/>
          <result version="4.0" url="http://192.168.152.1:7070/alfresco/SPP/_vti_history/versionStore://version2Store/eb8f6b0b-9327-4a42-90f8-e271a57c2f5c/aaa-test.txt" created="3/19/2011 3:42 PM" createdBy="admin" size="58" comments=""/>
        </results>
      </RestoreVersionResult>
    </RestoreVersionResponse>
  </s:Body>
</s:Envelope>
----

So this will be a SOAP call as well, and the new list of versions is returned.

Version delete: this is not supported by Alfresco. From its log:

----
16:30:11,469 User:admin DEBUG [web.ws.DeleteVersionEndpoint] Soap Method with name DeleteVersion is started.
16:30:11,470 User:admin DEBUG [web.ws.DeleteVersionEndpoint] Return error 'This operation is not supported by server.'
----

An other hardwired value in the proto right now is the type of a checkin. Documentation on possible values:
http://msdn.microsoft.com/en-us/library/lists.lists.checkinfile%28v=office.12%29.aspx
and
http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.spcheckintype%28v=office.12%29.aspx

Though looking at the implementation at
http://svn.alfresco.com/repos/alfresco-open-mirror/alfresco/HEAD/root/modules/sharepoint/amp/source/java/org/alfresco/module/vti/web/ws/,
CheckInFileEndpoint.execute() ignores that parameter, so that'll be again
something that can be later tested with native sharepoint only.

The next target is that we could support creating new spaces.

Fun fact: uploading a txt file to an existing space is perfectly OK, but the
initial document in a space must be a docx (or probably doc).

Anyway, the space creation is a SOAP request as well
(20110319-create-space.dump):

- flow #2:

----
POST /alfresco/_vti_bin/dws.asmx HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: http://schemas.microsoft.com/sharepoint/soap/dws/CreateDws
X-Office-Version: 12.0.6213
User-Agent: Microsoft Office/12.0 (Windows NT 5.1; Microsoft Office Word 12.0.6213; Pro)
Host: 192.168.152.1:7070
Content-Length: 268
Connection: Keep-Alive
Cache-Control: no-cache

<?xml version='1.0' ?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><CreateDws xmlns="http://schemas.microsoft.com/sharepoint/soap/dws/"><name></name><users></users><title>SPP_3</title><documents></documents></CreateDws></s:Body></s:Envelope>
----

reply:

----
<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><CreateDwsResponse xmlns="http://schemas.microsoft.com/sharepoint/soap/dws/"><CreateDwsResult>&lt;Results&gt;&lt;Url&gt;http://192.168.152.1:7070/alfresco/SPP_3&lt;/Url&gt;&lt;DoclibUrl&gt;documentLibrary&lt;/DoclibUrl&gt;&lt;ParentWeb/&gt;&lt;FailedUsers&gt;&lt;/FailedUsers&gt;&lt;/Results&gt;</CreateDwsResult></CreateDwsResponse></s:Body></s:Envelope>
----

I implemented this as a 'create-space' subcommand in the proto.

I also tried deleting a space, but that's not supported by alfresco.

To sum up:

- created 'create-space', 'open-older' and 'restore-version' features
- 'checkin type', 'version delete' and 'space delete' is not supported by Alfresco

Next, I want to continue with deleting files, so far what I checked is that
alfresco supports it.

== 7th week

=== 2011-03-21

In ULX. Creating a table about features (what is supported, what is not, etc).

Checking in Wireshark how deleting documents from a space works (20110321-docdel.dump):

- flow #3:

----
POST /alfresco/SPP/_vti_bin/_vti_aut/author.dll HTTP/1.1

method=remove+documents%3a12%2e0%2e0%2e6211&service%5fname=%2falfresco%2fSPP&url%5flist=%5bdocumentLibrary%2flocal3%2edoc%5d
----

response:

----
<html><head><title>vermeer RPC packet</title></head>
<body>
<p>method=remove documents:14.0.0.4730
<p>message=successfully removed documents
...
----

so it's a 'remove documents' method in that weird RPC syntax. I implemented
this feature in the proto.

At this point I think the proto has enough features that I could start
implementing the extension. OTOH sadly the virtual machine providing sharepoint
is not yet ready, and it would be nice to be sure the proto is working with
sharepoint before I start turning the proto to Java code.

In the meantime I'm setting up Eclipse + OOEclipse + Alfresco SDK on my
machine, which has been partly done already on the ULX box.

The tutorial which one I already tried:

http://wiki.services.openoffice.org/wiki/JavaEclipseTuto

Given that I had the best results with 3.5 (Galileo) and stable OOEclipse, I
try these now.

Wasted a lot of time to find a working galileo mirror, it seems most of them
don't contain anything older than helios (this time I needed a 32bit linux
binary). This one is fast:
http://cloud.eclipsesource.com/SR2/eclipse-SDK-3.5.2-linux-gtk.tar.gz

As described on 2010-02-28, tweaking PATH is necessary before starting Eclipse:

----
export PATH=$HOME/git/libreoffice/ooo-build-3-2-1/usr/lib/openoffice.org/program:$PATH
----

(that's where I have the 3.2 version installed)

There is that weird OOo Basic language, and it seems I can't really avoid
learning a bit of it, as the loader of the OPAL contains some Basic code as
well. So here is a guide:

http://openoffice.ozlady.com/2010/09/openoffice-org-3-2-guide-to-programming-in-ooo-basic-how-to-guide/

Even if it's 172 pages long, it does not explain how to run a hello world macro...

So given the code of a Basic function, it can be added to a document using:

Macros -> Organise macros -> OpenOffice.org basic, then there edit Main, paste
the code to the end of the edit window, File -> Save, File -> Close, then
select Tools -> Macros -> Run macro, and there select My Macros -> Standard ->
Module1, and there it's possible to select testHelloworld. And finally, for the
first time, it can call my Java code! :)

Now let's see what is the workflow from hacking to testing working code. It
seems the best I can do is:

- remove previous version of the extension in OOo, restart it
- hack hack hack in Eclipse
- right click on project -> Properties (UNO part already selected), OK (that is necessary as after every export Eclipse forgets the OOo SDK path...)
- File -> Export (UNO already selected), next, finish. Deploy? Yes. OK to install? OK.
- Close the extension manager.
- Tools -> Macros -> Run macro will run the new version of the extension now.
