= Diploma 2 log

== 1st week

=== 2011-09-06

In ULX, meeting with Gabor, Ivan and Akos, discussing what "workflow
integration in an office environment" means.

No consensus, next meeting scheduled later this week.

=== 2011-09-07

Replied to redmine ticket: the LPSP extension fails to open a GUI window on
OSX. I already found a possible fix, searched the exact commit and bug id.

Set up a sharepoint virtual machine on localhost. (I can't get wireshark to
monitor the traffic in both directions when sharepoint runs on a remote virtual
machine.)

=== 2011-09-08

Meeting with Akos: we clarified most of the points in the initial "for this
semester" spec, I need to write up a more detailed one.

Meeting with Ivan and Gabor: more discussion, especially about what does a
long-term workflow stand for, decision points and undoing a task assignment.

Wrote up a more detailed spec in SVN.

=== 2011-09-09

In ULX. Ivan pointed out a drools (including jbmp5) demo they set up earlier:

http://droolsdemo-process:8080/gwt-console/
http://droolsdemo-process:8080/gwt-console-server/

Based on that, I'm trying to set up my own jbmp instance. Downloaded
jbpm-5.1.0.Final-installer-full.zip from
http://sourceforge.net/projects/jbpm/files/jBPM%205/jbpm-5.1.0.Final/.

Following the install.html from that ZIP, I get a web console at
http://localhost:8080/jbpm-console, and the REST API at
http://localhost:8080/gwt-console-server/.

Found more documentation at: http://docs.jboss.org/jbpm/v5.1/userguide/

This was also helpful: http://jkrzemie.wordpress.com/2011/03/30/jbpm-5-0-creating-simple-human-tasks-with-variables/

Questions:
- where are human task templates stored? -> looks like in separate .ftl files, have to be deployed using guvnor.
- user management? -> should be plain ini-like text files under auth/, but that did not really work here for some reason.
- rest interface auth problems -> the example provided in the documentation is obsolete, using apache httpclient should be a solution, example here: http://anonsvn.jboss.org/repos/riftsaw/trunk/samples/quickstart/management/src/org/jboss/riftsaw/management/ManagementClient.java

=== 2011-09-10

- I have a working example on how to authenticate and get list of personal tasks as JSON.
- Also read about gson: http://code.google.com/p/google-gson/ which is used by
  jboss to serialize / unserialize java objects to/from json. I now have a
  working example on how to build a List<Task> object from a JSON result (as
  far as I see, it's necessary to write TaskRef.java and TaskRefWrapper.java
  manually to do so).

Then I looked at related work. Keywords: 'document based workflow',
'document-driven workflow', 'document-centric workflows'.

- http://php.scripts.psu.edu/faculty/a/x/axk41/BPM05-jerry-reprint.pdf
  A framework for document-driven workflow systems (J Wang)
  -> details why information and resource based workflows are also important, not just control based ones
  -> idea: user changes the document, change listeners intercepts changes, check constraints, then accept or reject
           various complex features planned: split/merge of documents, different locking types
  -> implementation using sql triggers (ugh)
  -> detailed comparison of control flow based vs. document based approach (pro/con)
- https://mailserver.di.unipi.it/ricerca/proceedings/ICSE2008/sam/p21.pdf
  Mobility in the virtual office: a document-centric workflow approach (R Carbon, G Johann, T Keuler, D Muthig)
  -> introduces decentralized document-driven workflows, where changes to workflows travel with the documents
     decentralization is handled with a peer-to-peer architecture
- http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.86.6547&rep=rep1&type=pdf
  XDoC-WFMS: A Framework for Document Centric Workflow Management System (R Krishnan, L Munaga)
  -> great examples where document-centric approach is intuitive: newspaper editing, processing job applications
  -> idea: documents have an embedded micro-agent, so the document itself will know where to submit, etc.
- http://ce.sharif.edu/~yuosefsa/article/CS.pdf
  Access control in document-centric workflow systems--an agent-based approach (RA Botha)
  -> an approach without decoupling: here the workflow object communicates with the document object

=== 2011-09-11

Worked on the 'recently used documents' feature in the extension, requested by Ivan.

Version to test: lpsp-0.1-387-g273a329.oxt

Implemented functions:
- modified the extension configuration schema, so it can store a list of recently used URL's for each configured server.
- when opening a document, that list is loaded from $HOME/.openoffice.org/3/user/registrymodifications.xcu, the opened document is inserted to the start of the list, then saved.
- there is a new button in the file picker, making it possible to view this list
- the 'up' button can be used to return to the root directory from the recently used documents

== 2nd week

=== 2011-09-12

Worked on the favorites feature in the extension.

Version to test: lpsp-0.1-396-g4ecd817.oxt

Implemented functions:
- new button to add a folder or file to favorites
- add/delete is first confirmed using a popup dialog
- new button to list favorites
- as with recently used documents, the 'up' button can be used to return to the root directory

== 2011-09-13

Created my first BPMN with two human tasks (and committed to SVN). That sounds
easy, but there were two pitfalls:

- starting the h2 database and then starting jboss is not enough, there is a need to start a separate 'human task server' as well

So the proper way to restart jbpm after changing the BPMN and/or templates is:

----
ant stop.jboss && ant stop.h2 && ant start.h2 && ant start.jboss && ant start.human.task
----

- creating a new BPMN does not work with 'File -> New -> File', and just using
  the `.bpmn` extension, as that results in an XML reader exception, what works
  is: 'File -> New -> Other', then 'Drools -> Flow file'

== 2011-09-14

In ULX. Worked on completing a task via REST API, created an example
successfully. First I thought it will be easy as the login form already used
UrlEncodedFormEntity successfully, but on task completion a MultipartEntity
should be used to send the (empty) form.

Ported the sample codes to http-core 4.x (that is needed, as 3.x has a
different api, not supporting NTLM auth). Created a WFHandler (similar to the
Handler of the sharepoint jar):

- it can check username/password - login
- can list assigned tasks
- can complete a task
- can get the document url of a task
- can list documents: it simulates a root directory with documents, extracted from assigned tasks.

Figured out how to add new users to jbpm and/or change password: there is an
auth/users.properties file, but that's used by the installer only. The real
configuration file is under jboss-*/server/default/conf/users.properties. Once
updated and jbpm is restarted, logging in with the new user works fine.

Then - for some unknown reason - the eclipse of jbpm stopped recognizing bpmn
files as a graphically editable object, finally I had to re-deploy the eclipse
configuration.

Finally a problem: assigning a task to the user `krisv` works, but when I try to assign a task to the user `admin`, I get:

----
     [java] javax.persistence.RollbackException: Error while commiting the transaction
     [java]     at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:71)
     [java]     at org.jbpm.task.service.TaskServiceSession.doOperationInTransaction(TaskServiceSession.java:820)
     [java]     at org.jbpm.task.service.TaskServiceSession.addTask(TaskServiceSession.java:134)
     [java]     at org.jbpm.task.service.TaskServerHandler.messageReceived(TaskServerHandler.java:109)
     [java]     at org.jbpm.task.service.mina.MinaTaskServerHandler.messageReceived(MinaTaskServerHandler.java:41)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$TailFilter.messageReceived(DefaultIoFilterChain.java:713)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.access$1200(DefaultIoFilterChain.java:46)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$EntryImpl$1.messageReceived(DefaultIoFilterChain.java:793)
     [java]     at org.apache.mina.filter.codec.ProtocolCodecFilter$ProtocolDecoderOutputImpl.flush(ProtocolCodecFilter.java:375)
     [java]     at org.apache.mina.filter.codec.ProtocolCodecFilter.messageReceived(ProtocolCodecFilter.java:229)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.access$1200(DefaultIoFilterChain.java:46)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$EntryImpl$1.messageReceived(DefaultIoFilterChain.java:793)
     [java]     at org.apache.mina.filter.logging.LoggingFilter.messageReceived(LoggingFilter.java:176)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.access$1200(DefaultIoFilterChain.java:46)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain$EntryImpl$1.messageReceived(DefaultIoFilterChain.java:793)
     [java]     at org.apache.mina.core.filterchain.IoFilterAdapter.messageReceived(IoFilterAdapter.java:119)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.callNextMessageReceived(DefaultIoFilterChain.java:434)
     [java]     at org.apache.mina.core.filterchain.DefaultIoFilterChain.fireMessageReceived(DefaultIoFilterChain.java:426)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.read(AbstractPollingIoProcessor.java:638)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.process(AbstractPollingIoProcessor.java:598)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.process(AbstractPollingIoProcessor.java:587)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor.access$400(AbstractPollingIoProcessor.java:61)
     [java]     at org.apache.mina.core.polling.AbstractPollingIoProcessor$Processor.run(AbstractPollingIoProcessor.java:969)
     [java]     at org.apache.mina.util.NamePreservingRunnable.run(NamePreservingRunnable.java:64)
     [java]     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
     [java]     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
     [java]     at java.lang.Thread.run(Thread.java:679)
     [java] Caused by: org.hibernate.exception.ConstraintViolationException: Could not execute JDBC batch update
     [java]     at org.hibernate.exception.SQLStateConverter.convert(SQLStateConverter.java:94)
     [java]     at org.hibernate.exception.JDBCExceptionHelper.convert(JDBCExceptionHelper.java:66)
     [java]     at org.hibernate.jdbc.AbstractBatcher.executeBatch(AbstractBatcher.java:275)
     [java]     at org.hibernate.engine.ActionQueue.executeActions(ActionQueue.java:266)
     [java]     at org.hibernate.engine.ActionQueue.executeActions(ActionQueue.java:168)
     [java]     at org.hibernate.event.def.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:321)
     [java]     at org.hibernate.event.def.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:50)
     [java]     at org.hibernate.impl.SessionImpl.flush(SessionImpl.java:1027)
     [java]     at org.hibernate.impl.SessionImpl.managedFlush(SessionImpl.java:365)
     [java]     at org.hibernate.transaction.JDBCTransaction.commit(JDBCTransaction.java:137)
     [java]     at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:54)
     [java]     ... 29 more
     [java] Caused by: org.h2.jdbc.JdbcBatchUpdateException: Referential integrity constraint violation: "FK27A9A59E619A0: PUBLIC.TASK FOREIGN KEY(CREATEDBY_ID) REFERENCES PUBLIC.ORGANIZATIONALENTITY(ID)"; SQL statement:
     [java] update Task set allowedToDelegate=?, taskInitiator_id=?, priority=?, activationTime=?, actualOwner_id=?, createdBy_id=?, createdOn=?, documentAccessType=?, documentContentId=?, documentType=?, expirationTime=?, faultAccessType=?, faultContentId=?, faultName=?, faultType=?, outputAccessType=?, outputContentId=?, outputType=?, parentId=?, previousStatus=?, processInstanceId=?, skipable=?, status=?, workItemId=? where id=? [23002-124]
     [java]     at org.h2.jdbc.JdbcPreparedStatement.executeBatch(JdbcPreparedStatement.java:1082)
     [java]     at org.hibernate.jdbc.BatchingBatcher.doExecuteBatch(BatchingBatcher.java:70)
     [java]     at org.hibernate.jdbc.AbstractBatcher.executeBatch(AbstractBatcher.java:268)
     [java]     ... 37 more
----

I'll try to see what are the differences between the two accounts.

TODO:

- Requested by Gabor: I develop on OOo 3.3 and Linux, test the extension on
  Windows and Linux, OOo 3.3 and LO 3.4 (and send mail when done)
- create working example for completing a human task via REST: making a binary decision
- look for more related work on 'document based workflows'
- look up Alfresco source code to see if minor/major versions are still ignored
  in Sharepoint mode
